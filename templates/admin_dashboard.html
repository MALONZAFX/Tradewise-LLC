{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TradeWise Admin Dashboard</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Theme style -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #28a745;
            --info: #17a2b8;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
        }
        
        .btn-gradient-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
        }
        
        .content-tab {
            display: none;
        }
        
        .content-tab.active {
            display: block;
        }
        
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .progress-thin {
            height: 6px;
        }
        
        .card-analytics {
            border-left: 4px solid var(--primary);
        }
        
        /* Activity Timeline Styles */
        .activity-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--primary);
        }
        
        .activity-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .activity-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
        }
        
        .hidden-activities {
            display: none;
        }
        
        .view-more-container {
            text-align: center;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .hidden-request {
            display: none;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            display: none;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        /* Fix AdminLTE Footer Overlap */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .content-wrapper {
            flex: 1;
            padding-bottom: 60px;
        }

        .main-footer {
            margin-top: auto;
            background: #343a40;
            color: white;
            padding: 15px;
            border-top: 1px solid #4b545c;
        }

        /* Loading States */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            color: white;
            font-size: 2rem;
        }

        .btn-loading {
            position: relative;
        }

        .btn-loading .spinner {
            display: none;
            margin-right: 8px;
        }

        .btn-loading.loading .spinner {
            display: inline-block;
        }

        /* Live Update Indicators */
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* AJAX Success Messages */
        .ajax-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Software Management Styles */
        .software-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 2px solid #e9ecef;
        }
        .software-thumbnail:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }
        .no-thumbnail {
            text-align: center;
            padding: 5px;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .software-description {
            cursor: help;
        }
        .download-stats {
            text-align: center;
        }
        .download-count {
            font-weight: bold;
            font-size: 1.1em;
        }
        .empty-state {
            padding: 40px 20px;
        }
        
        /* Reviews Management Styles */
        .star-rating-input-large {
            direction: rtl;
            display: inline-block;
            font-size: 2rem;
        }
        .star-rating-input-large input {
            display: none;
        }
        .star-rating-input-large .star-label {
            color: #ddd;
            font-size: 2.5rem;
            padding: 0 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .star-rating-input-large input:checked ~ .star-label,
        .star-rating-input-large input:hover ~ .star-label {
            color: #f1c40f;
        }
        .star-rating-input-large .star-label:hover,
        .star-rating-input-large .star-label:hover ~ .star-label {
            color: #f1c40f;
        }
        .star-rating-display {
            font-size: 1.2rem;
        }
        .star-rating-display .star {
            color: #ddd;
        }
        .star-rating-display .star.filled {
            color: #f1c40f;
        }
        .review-text {
            cursor: help;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .no-avatar {
            font-size: 1rem;
        }
        .info-box {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .info-box:hover {
            transform: translateY(-2px);
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="globalLoading">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <span class="ml-2">Processing...</span>
        </div>
    </div>

    <div class="wrapper">

        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="{% url 'index' %}" class="nav-link">View Live Site</a>
                </li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link" data-toggle="dropdown" href="#">
                        <i class="far fa-bell"></i>
                        {% if pending_requests_count > 0 %}
                        <span class="badge badge-warning navbar-badge" id="notificationBadge">{{ pending_requests_count }}</span>
                        {% endif %}
                    </a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                        <span class="dropdown-item dropdown-header" id="notificationHeader">{{ pending_requests_count }} Notifications</span>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" data-tab="all-requests">
                            <i class="fas fa-users mr-2"></i> <span id="newUsersCount">{{ new_users_today }}</span> new users
                            <span class="float-right text-muted text-sm">Today</span>
                        </a>
                        <a href="#" class="dropdown-item" data-tab="all-requests">
                            <i class="fas fa-clock mr-2"></i> <span id="pendingRequestsCount">{{ pending_requests_count }}</span> pending requests
                            <span class="float-right text-muted text-sm">Action needed</span>
                        </a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'admin_logout' %}">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Sidebar Container -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <a href="{% url 'admin_dashboard' %}" class="brand-link">
                <img src="{% static 'images/TRADE-WISE-FINAL-TRANSPARENT.png' %}" alt="TradeWise Logo" class="brand-image img-circle elevation-3">
                <span class="brand-text font-weight-light">TradeWise Admin</span>
            </a>

            <div class="sidebar">
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">
                        <img src="https://ui-avatars.com/api/?name={{ request.user.get_full_name }}&background=3498db&color=fff" class="img-circle elevation-2" alt="User Image">
                    </div>
                    <div class="info">
                        <a href="#" class="d-block">{{ request.user.get_full_name }}</a>
                        <small class="text-success"><i class="fas fa-circle"></i> Online</small>
                    </div>
                </div>

                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-tab="dashboard">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        
                        <li class="nav-header">CONTENT MANAGEMENT</li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="strategies">
                                <i class="nav-icon fas fa-chess-knight"></i>
                                <p>Trading Strategies</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="signals">
                                <i class="nav-icon fas fa-bell"></i>
                                <p>Trading Signals</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="classes">
                                <i class="nav-icon fas fa-graduation-cap"></i>
                                <p>Trading Classes</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="services">
                                <i class="nav-icon fas fa-cogs"></i>
                                <p>Services</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="software">
                                <i class="nav-icon fas fa-download"></i>
                                <p>Software & Tools</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="blog">
                                <i class="nav-icon fas fa-blog"></i>
                                <p>Blog Management</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="tradewise-card">
                                <i class="nav-icon fas fa-id-card"></i>
                                <p>TradeWise Card</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="merchandise">
                                <i class="nav-icon fas fa-tshirt"></i>
                                <p>Merchandise</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="tradewise-coin">
                                <i class="nav-icon fas fa-coins"></i>
                                <p>TradeWise Coin</p>
                            </a>
                        </li>
                        
                        <!-- REVIEWS NAVIGATION ITEM -->
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="reviews">
                                <i class="nav-icon fas fa-star"></i>
                                <p>Reviews Management</p>
                                {% if pending_reviews > 0 %}
                                <span class="badge badge-warning float-right" id="pendingReviewsBadge">{{ pending_reviews }}</span>
                                {% endif %}
                            </a>
                        </li>

                        <li class="nav-header">REQUESTS MANAGEMENT</li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="all-requests">
                                <i class="nav-icon fas fa-inbox"></i>
                                <p>All Service Requests</p>
                                {% if pending_requests_count > 0 %}
                                <span class="badge badge-warning float-right" id="pendingRequestsBadge">{{ pending_requests_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                        
                        <li class="nav-header">USER MANAGEMENT</li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="users">
                                <i class="nav-icon fas fa-users"></i>
                                <p>Users</p>
                                <span class="badge badge-info float-right" id="totalUsersBadge">{{ total_users }}</span>
                            </a>
                        </li>

                        <li class="nav-header">AFFILIATE MANAGEMENT</li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-tab="affiliate-management">
                                <i class="nav-icon fas fa-users"></i>
                                <p>Affiliate Program</p>
                                {% if pending_payouts_count > 0 %}
                                <span class="badge badge-warning float-right" id="pendingPayoutsBadge">{{ pending_payouts_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- Content Wrapper -->
        <div class="content-wrapper">
            <section class="content">
                <div class="container-fluid">
                    
                    <!-- AJAX Messages Container -->
                    <div id="ajaxMessagesContainer"></div>
                    
                    <!-- Display Django Messages -->
                    {% if messages %}
                    <div class="row">
                        <div class="col-12">
                            {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
                                {{ message }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- DASHBOARD TAB -->
                    <div id="dashboard" class="content-tab active">
                        <!-- Quick Stats Row -->
                        <div class="row">
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-gradient-primary stat-card">
                                    <div class="inner">
                                        <h3 id="totalUsersStat">{{ total_users }}</h3>
                                        <p>Total Users</p>
                                        <div class="progress progress-thin mt-2">
                                            <div class="progress-bar bg-white" style="width: {{ user_growth_percentage }}%"></div>
                                        </div>
                                        <small id="newUsersToday">+{{ new_users_today }} today</small>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <a href="#" class="small-box-footer" data-tab="users">
                                        View Users <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-success stat-card">
                                    <div class="inner">
                                        <h3 id="totalRevenueStat">KES {{ total_revenue|floatformat:0 }}</h3>
                                        <p>Total Revenue <span class="live-indicator" title="Live Updates"></span></p>
                                        <div class="progress progress-thin mt-2">
                                            <div class="progress-bar bg-white" style="width: {{ revenue_growth_percentage }}%"></div>
                                        </div>
                                        <small id="revenueGrowth">+{{ revenue_growth }}% this month</small>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <a href="#" class="small-box-footer" data-tab="all-requests">
                                        View Reports <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-warning stat-card">
                                    <div class="inner">
                                        <h3 id="pendingRequestsStat">{{ pending_requests_count }}</h3>
                                        <p>Pending Requests</p>
                                        <div class="progress progress-thin mt-2">
                                            <div class="progress-bar bg-white" style="width: {{ requests_percentage }}%"></div>
                                        </div>
                                        <small id="newRequestsToday">{{ new_requests_today }} new today</small>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <a href="#" class="small-box-footer" data-tab="all-requests">
                                        Manage Requests <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-danger stat-card">
                                    <div class="inner">
                                        <h3 id="activeTradersStat">{{ active_traders }}</h3>
                                        <p>Active Traders</p>
                                        <div class="progress progress-thin mt-2">
                                            <div class="progress-bar bg-white" style="width: {{ active_traders_percentage }}%"></div>
                                        </div>
                                        <small id="newTradersToday">+{{ new_traders_today }} today</small>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <a href="#" class="small-box-footer" data-tab="users">
                                        View Accounts <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics & Charts Row -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card card-analytics">
                                    <div class="card-header">
                                        <h3 class="card-title">
                                            Revenue Analytics (Last 30 Days) 
                                            <span class="live-indicator" title="Live Updates"></span>
                                            <small class="text-muted float-right" id="chartLastUpdated">Updating...</small>
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="revenueChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Service Distribution</h3>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="serviceDistributionChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity with View More -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">
                                            Recent Activity 
                                            <span class="live-indicator" title="Live Updates"></span>
                                        </h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <button type="button" class="btn btn-tool" onclick="refreshActivity()" title="Refresh Activity">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="activity-timeline p-3" id="activityTimeline">
                                            <!-- Activities will be loaded via AJAX -->
                                            <div class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                                <p class="mt-2 text-muted">Loading activities...</p>
                                            </div>
                                        </div>
                                        <div class="view-more-container" id="viewMoreContainer" style="display: none;">
                                            <button id="viewMoreBtn" class="btn btn-sm btn-outline-primary" onclick="toggleActivities()">
                                                <i class="fas fa-chevron-down"></i> View More Activities
                                            </button>
                                            <button id="viewLessBtn" class="btn btn-sm btn-outline-secondary" onclick="toggleActivities()" style="display: none;">
                                                <i class="fas fa-chevron-up"></i> View Less
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STRATEGIES MANAGEMENT TAB -->
                    <div id="strategies" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Trading Strategies Management</h3>
                                <button class="btn btn-gradient-primary float-right" data-toggle="modal" data-target="#addStrategyModal">
                                    <i class="fas fa-plus"></i> Add New Strategy
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Image</th>
                                                <th>Strategy Name</th>
                                                <th>Description</th>
                                                <th>Price (USD)</th>
                                                <th>Price (KES)</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="strategiesTableBody">
                                            {% for strategy in strategies %}
                                            <tr>
                                                <td>STR{{ strategy.id|stringformat:"03d" }}</td>
                                                <td>
                                                    {% if strategy.image %}
                                                    <img src="{{ strategy.image.url }}" alt="{{ strategy.title }}" style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                    <span class="text-muted">No Image</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ strategy.title }}</td>
                                                <td>{{ strategy.description|truncatewords:10 }}</td>
                                                <td>${{ strategy.price_usd }}</td>
                                                <td>KES {{ strategy.price_kes }}</td>
                                                <td>
                                                    {% if strategy.is_active %}
                                                    <span class="badge badge-success">Active</span>
                                                    {% else %}
                                                    <span class="badge badge-secondary">Inactive</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ strategy.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" onclick="editStrategy({{ strategy.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('strategy', {{ strategy.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="9" class="text-center text-muted">No strategies found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SIGNALS MANAGEMENT TAB -->
                    <div id="signals" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Trading Signals Management</h3>
                                <button class="btn btn-gradient-primary float-right" data-toggle="modal" data-target="#addSignalModal">
                                    <i class="fas fa-plus"></i> Add New Signal
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Image</th>
                                                <th>Signal Name</th>
                                                <th>Description</th>
                                                <th>Price (USD)</th>
                                                <th>Price (KES)</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for signal in signals %}
                                            <tr>
                                                <td>SIG{{ signal.id|stringformat:"03d" }}</td>
                                                <td>
                                                    {% if signal.image %}
                                                    <img src="{{ signal.image.url }}" alt="{{ signal.title }}" style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                    <span class="text-muted">No Image</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ signal.title }}</td>
                                                <td>{{ signal.description|truncatewords:10 }}</td>
                                                <td>${{ signal.price_usd }}</td>
                                                <td>KES {{ signal.price_kes }}</td>
                                                <td>
                                                    {% if signal.is_active %}
                                                    <span class="badge badge-success">Active</span>
                                                    {% else %}
                                                    <span class="badge badge-secondary">Inactive</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ signal.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" onclick="editSignal({{ signal.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('signal', {{ signal.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="9" class="text-center text-muted">No signals found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CLASSES MANAGEMENT TAB -->
                    <div id="classes" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Trading Classes Management</h3>
                                <button class="btn btn-gradient-primary float-right" data-toggle="modal" data-target="#addClassModal">
                                    <i class="fas fa-plus"></i> Add New Class
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Image</th>
                                                <th>Class Name</th>
                                                <th>Description</th>
                                                <th>Price</th>
                                                <th>Duration</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for class in classes %}
                                            <tr>
                                                <td>CLS{{ class.id|stringformat:"03d" }}</td>
                                                <td>
                                                    {% if class.image %}
                                                    <img src="{{ class.image.url }}" alt="{{ class.title }}" style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                    <span class="text-muted">No Image</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ class.title }}</td>
                                                <td>{{ class.description|truncatewords:10 }}</td>
                                                <td>${{ class.price }}</td>
                                                <td>{{ class.duration }}</td>
                                                <td>
                                                    <span class="badge badge-success">Active</span>
                                                </td>
                                                <td>{{ class.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" onclick="editClass({{ class.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('class', {{ class.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="9" class="text-center text-muted">No classes found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SERVICES MANAGEMENT TAB -->
                    <div id="services" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Services Management</h3>
                                <button class="btn btn-gradient-primary float-right" data-toggle="modal" data-target="#addServiceModal">
                                    <i class="fas fa-plus"></i> Add New Service
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Service Name</th>
                                                <th>Category</th>
                                                <th>Price</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for service in services %}
                                            <tr>
                                                <td>SRV{{ service.id|stringformat:"03d" }}</td>
                                                <td>{{ service.title }}</td>
                                                <td>{{ service.category|title }}</td>
                                                <td>{{ service.price_label }}</td>
                                                <td>
                                                    {% if service.is_active %}
                                                    <span class="badge badge-success">Active</span>
                                                    {% else %}
                                                    <span class="badge badge-secondary">Inactive</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ service.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" onclick="editService({{ service.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('service', {{ service.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">No services found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SOFTWARE MANAGEMENT TAB -->
                    <div id="software" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Software & Tools Management</h3>
                                <button class="btn btn-gradient-primary float-right" data-toggle="modal" data-target="#addSoftwareModal">
                                    <i class="fas fa-plus"></i> Add New Software
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Software Statistics Cards -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card stat-card bg-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="flex-grow-1">
                                                        <h4 class="mb-0">{{ software_list.count }}</h4>
                                                        <span>Total Software</span>
                                                    </div>
                                                    <div class="flex-shrink-0">
                                                        <i class="fas fa-cube fa-2x"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card stat-card bg-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="flex-grow-1">
                                                        <h4 class="mb-0">{{ active_software_count }}</h4>
                                                        <span>Active Software</span>
                                                    </div>
                                                    <div class="flex-shrink-0">
                                                        <i class="fas fa-check-circle fa-2x"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card stat-card bg-info text-white">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="flex-grow-1">
                                                        <h4 class="mb-0">{{ total_downloads }}</h4>
                                                        <span>Total Downloads</span>
                                                    </div>
                                                    <div class="flex-shrink-0">
                                                        <i class="fas fa-download fa-2x"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card stat-card bg-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center">
                                                    <div class="flex-grow-1">
                                                        <h4 class="mb-0">{{ software_types_count }}</h4>
                                                        <span>Software Types</span>
                                                    </div>
                                                    <div class="flex-shrink-0">
                                                        <i class="fas fa-layer-group fa-2x"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Software Table -->
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Thumbnail</th>
                                                <th>Software Name</th>
                                                <th>Description</th>
                                                <th>Version</th>
                                                <th>Type</th>
                                                <th>Downloads</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for software in software_list %}
                                            <tr>
                                                <td>
                                                    <span class="badge badge-primary">SW{{ software.id|stringformat:"03d" }}</span>
                                                </td>
                                                <td>
                                                    {% if software.thumbnail %}
                                                    <img src="{{ software.thumbnail.url }}" alt="{{ software.name }}" 
                                                         class="software-thumbnail" 
                                                         data-toggle="tooltip" 
                                                         title="{{ software.name }}"
                                                         onclick="showImageModal('{{ software.thumbnail.url }}', '{{ software.name }}')">
                                                    {% else %}
                                                    <div class="no-thumbnail">
                                                        <i class="fas fa-cube fa-2x text-muted"></i>
                                                        <small class="d-block text-muted">No Image</small>
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong>{{ software.name }}</strong>
                                                </td>
                                                <td>
                                                    <span class="software-description" 
                                                          data-toggle="tooltip" 
                                                          title="{{ software.description }}">
                                                        {{ software.description|truncatewords:8 }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge badge-info">v{{ software.version }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if software.file_type == 'software' %}badge-primary
                                                        {% elif software.file_type == 'ebook' %}badge-success
                                                        {% elif software.file_type == 'indicator' %}badge-warning
                                                        {% else %}badge-secondary{% endif %}">
                                                        {{ software.get_file_type_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="download-stats">
                                                        <span class="download-count">{{ software.download_count }}</span>
                                                        <small class="text-muted d-block">downloads</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if software.is_active %}
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check-circle"></i> Active
                                                    </span>
                                                    {% else %}
                                                    <span class="badge badge-secondary">
                                                        <i class="fas fa-pause-circle"></i> Inactive
                                                    </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {{ software.created_at|date:"M d, Y" }}<br>
                                                        <span class="text-muted">{{ software.created_at|date:"H:i" }}</span>
                                                    </small>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <a href="{{ software.file.url }}" 
                                                           class="btn btn-success" 
                                                           download
                                                           data-toggle="tooltip" 
                                                           title="Download {{ software.name }}"
                                                           onclick="trackDownload({{ software.id }})">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                        <button type="button" 
                                                                class="btn btn-info" 
                                                                data-toggle="tooltip" 
                                                                title="View Details"
                                                                onclick="showSoftwareDetails({{ software.id }})">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button type="button" 
                                                                class="btn btn-warning" 
                                                                data-toggle="tooltip" 
                                                                title="Edit Software"
                                                                onclick="editSoftware({{ software.id }})">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" 
                                                                class="btn btn-danger" 
                                                                data-toggle="tooltip" 
                                                                title="Delete Software"
                                                                onclick="deleteSoftware({{ software.id }}, '{{ software.name }}')">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="10" class="text-center py-5">
                                                    <div class="empty-state">
                                                        <i class="fas fa-cube fa-4x text-muted mb-3"></i>
                                                        <h5 class="text-muted">No Software Found</h5>
                                                        <p class="text-muted">Get started by adding your first software tool.</p>
                                                        <button class="btn btn-gradient-primary" data-toggle="modal" data-target="#addSoftwareModal">
                                                            <i class="fas fa-plus"></i> Add First Software
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                {% if software_list.has_other_pages %}
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <nav aria-label="Software pagination">
                                            <ul class="pagination justify-content-center">
                                                {% if software_list.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?software_page={{ software_list.previous_page_number }}#software">Previous</a>
                                                </li>
                                                {% else %}
                                                <li class="page-item disabled">
                                                    <span class="page-link">Previous</span>
                                                </li>
                                                {% endif %}

                                                {% for i in software_list.paginator.page_range %}
                                                {% if software_list.number == i %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ i }}</span>
                                                </li>
                                                {% else %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?software_page={{ i }}#software">{{ i }}</a>
                                                </li>
                                                {% endif %}
                                                {% endfor %}

                                                {% if software_list.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?software_page={{ software_list.next_page_number }}#software">Next</a>
                                                </li>
                                                {% else %}
                                                <li class="page-item disabled">
                                                    <span class="page-link">Next</span>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- BLOG MANAGEMENT TAB -->
                    <div id="blog" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Blog Management</h3>
                                <button class="btn btn-gradient-primary float-right" data-toggle="modal" data-target="#addBlogModal">
                                    <i class="fas fa-plus"></i> Add New Blog Post
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Image</th>
                                                <th>Title</th>
                                                <th>Content</th>
                                                <th>Author</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for post in blog_posts %}
                                            <tr>
                                                <td>BLG{{ post.id|stringformat:"03d" }}</td>
                                                <td>
                                                    {% if post.image %}
                                                    <img src="{{ post.image.url }}" alt="{{ post.title }}" style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                    <span class="text-muted">No Image</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ post.title }}</td>
                                                <td>{{ post.content|truncatewords:10 }}</td>
                                                <td>{{ post.author }}</td>
                                                <td>
                                                    {% if post.is_published %}
                                                    <span class="badge badge-success">Published</span>
                                                    {% else %}
                                                    <span class="badge badge-secondary">Draft</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ post.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" onclick="editBlog({{ post.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('blog', {{ post.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">No blog posts found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TRADEWISE CARD TAB -->
                    <div id="tradewise-card" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">TradeWise Card Management</h3>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{% url 'admin_dashboard' %}" enctype="multipart/form-data" data-ajax="true">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="update_card">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <!-- Simple Fields Section -->
                                            <div class="form-group">
                                                <label for="cardNumber">Card Number</label>
                                                <input type="text" class="form-control" id="cardNumber" name="card_number" 
                                                       value="{{ tradewise_card.card_number|default:'6734 559' }}" required>
                                                <small class="form-text text-muted">The card number to display on the frontend</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="capitalAvailable">Capital Available</label>
                                                <input type="text" class="form-control" id="capitalAvailable" name="capital_available" 
                                                       value="{{ tradewise_card.capital_available|default:'$500,000' }}" required>
                                                <small class="form-text text-muted">The capital amount to display</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="partnerName">Partner Name</label>
                                                <input type="text" class="form-control" id="partnerName" name="partner_name" 
                                                       value="{{ tradewise_card.partner_name|default:'SPALIS FX' }}" required>
                                                <small class="form-text text-muted">Partner name to display on the card</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="contactNumber">Contact Number</label>
                                                <input type="text" class="form-control" id="contactNumber" name="contact_number" 
                                                       value="{{ tradewise_card.contact_number|default:'+254742962615' }}" required>
                                                <small class="form-text text-muted">Contact number to display on the card</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Optional Fields (can be collapsed) -->
                                    <div class="mt-4">
                                        <a class="btn btn-outline-secondary btn-sm" data-toggle="collapse" href="#advancedSettings" role="button">
                                            <i class="fas fa-cog"></i> Advanced Settings (Optional)
                                        </a>
                                        
                                        <div class="collapse mt-3" id="advancedSettings">
                                            <div class="card card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="cardTitle">Card Title</label>
                                                            <input type="text" class="form-control" id="cardTitle" name="title" 
                                                                   value="{{ tradewise_card.title|default:'TradeWise Premium' }}">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="cardSubtitle">Subtitle</label>
                                                            <input type="text" class="form-control" id="cardSubtitle" name="subtitle" 
                                                                   value="{{ tradewise_card.subtitle|default:'' }}">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="cardDescription">Description</label>
                                                            <textarea class="form-control" id="cardDescription" name="description" rows="3">{{ tradewise_card.description|default:'Access premium trading features and exclusive content' }}</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="cardPriceMonthly">Monthly Price (USD)</label>
                                                            <input type="number" class="form-control" id="cardPriceMonthly" name="price_monthly" 
                                                                   value="{{ tradewise_card.price_monthly|default:'49.99' }}" step="0.01">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="cardPriceYearly">Yearly Price (USD)</label>
                                                            <input type="number" class="form-control" id="cardPriceYearly" name="price_yearly" 
                                                                   value="{{ tradewise_card.price_yearly|default:'499.99' }}" step="0.01">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="cardImage">Card Image</label>
                                                            <input type="file" class="form-control" id="cardImage" name="image" accept="image/*">
                                                            {% if tradewise_card.image %}
                                                            <div class="mt-2">
                                                                <img src="{{ tradewise_card.image.url }}" alt="Current image" style="max-width: 200px; border-radius: 8px;">
                                                                <small class="form-text text-muted">Current card image</small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group mt-4">
                                        <button type="submit" class="btn btn-gradient-primary">
                                            <i class="fas fa-save"></i> Update Card Details
                                        </button>
                                    </div>
                                </form>

                                <!-- Preview Section -->
                                <div class="mt-5">
                                    <h5>Live Preview</h5>
                                    <div class="card preview-card" style="background: linear-gradient(145deg, #1a2a4f 0%, #0d1a33 100%); border-radius: 20px; padding: 20px; color: white; max-width: 400px;">
                                        <div style="position: relative; overflow: hidden;">
                                            <!-- Card Watermark -->
                                            <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1; font-size: 6rem; font-weight: 700; color: white; transform: rotate(15deg);">TRADE</div>
                                            
                                            <!-- Card Content -->
                                            <div style="position: relative; z-index: 2;">
                                                <!-- Logo -->
                                                <div class="mb-3" style="display: flex; align-items: center;">
                                                    <div style="font-size: 1rem; font-weight: 600;">The Wisest Choice</div>
                                                </div>
                                                
                                                <!-- Card Number -->
                                                <div class="mb-3" style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">
                                                    <div style="font-size: 0.8rem; margin-bottom: 3px; opacity: 0.8;">TRADEWISE CARD</div>
                                                    <div style="font-size: 1.1rem; letter-spacing: 2px; font-weight: 600;">
                                                        {{ tradewise_card.card_number|default:'6734 559' }}
                                                    </div>
                                                </div>
                                                
                                                <!-- Capital Available -->
                                                <div class="mb-3">
                                                    <div style="font-size: 0.8rem; opacity: 0.8;">CAPITAL AVAILABLE</div>
                                                    <div style="font-size: 1.5rem; font-weight: 700;">
                                                        {{ tradewise_card.capital_available|default:'$500,000' }}
                                                    </div>
                                                </div>
                                                
                                                <!-- Partner Info -->
                                                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                                    <div>
                                                        <div style="font-size: 0.8rem; opacity: 0.8;">PARTNER</div>
                                                        <div style="font-size: 0.9rem; font-weight: 600;">
                                                            {{ tradewise_card.partner_name|default:'SPALIS FX' }}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 0.8rem; opacity: 0.8;">CONTACT</div>
                                                        <div style="font-size: 0.9rem; font-weight: 600;">
                                                            {{ tradewise_card.contact_number|default:'+254742962615' }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">This is how your card will appear on the website</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MERCHANDISE TAB -->
                    <div id="merchandise" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Merchandise Management</h3>
                                <button class="btn btn-gradient-primary float-right" data-toggle="modal" data-target="#addMerchandiseModal">
                                    <i class="fas fa-plus"></i> Add New Merchandise
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Image</th>
                                                <th>Name</th>
                                                <th>Category</th>
                                                <th>Description</th>
                                                <th>Price (KES)</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in merchandise_list %}
                                            <tr>
                                                <td>MCH{{ item.id|stringformat:"03d" }}</td>
                                                <td>
                                                    {% if item.image %}
                                                    <img src="{{ item.image.url }}" alt="{{ item.name }}" style="width: 50px; height: 50px; object-fit: cover;" class="img-thumbnail">
                                                    {% else %}
                                                    <span class="text-muted">No Image</span>
                                                    {% endif %}
                                                </td>
                                                <td><strong>{{ item.name }}</strong></td>
                                                <td>
                                                    <span class="badge badge-primary">{{ item.get_category_display }}</span>
                                                </td>
                                                <td>{{ item.description|truncatewords:10 }}</td>
                                                <td><strong>KES {{ item.price }}</strong></td>
                                                <td>{{ item.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button class="btn btn-sm btn-info" onclick="editMerchandise({{ item.id }})" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="deleteItem('merchandise', {{ item.id }})" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-success" onclick="previewMerchandise({{ item.id }})" title="Preview">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="8" class="text-center text-muted py-4">
                                                    <i class="fas fa-box-open fa-3x mb-3"></i>
                                                    <p>No merchandise items found</p>
                                                    <button class="btn btn-primary" data-toggle="modal" data-target="#addMerchandiseModal">
                                                        Add Your First Item
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TRADEWISE COIN TAB -->
                    <div id="tradewise-coin" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">TradeWise Coin Management</h3>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{% url 'admin_dashboard' %}" enctype="multipart/form-data" data-ajax="true">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="update_coin">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="coinTitle">Coin Title</label>
                                                <input type="text" class="form-control" id="coinTitle" name="title" 
                                                       value="{{ tradewise_coin.title|default:'TradeWise Coin' }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="coinSubtitle">Subtitle</label>
                                                <input type="text" class="form-control" id="coinSubtitle" name="subtitle" 
                                                       value="{{ tradewise_coin.subtitle|default:'' }}">
                                            </div>
                                            <div class="form-group">
                                                <label for="coinDescription">Description</label>
                                                <textarea class="form-control" id="coinDescription" name="description" rows="6" required>{{ tradewise_coin.description|default:'The future of decentralized trading is here. TradeWise Coin (TWC) is a revolutionary utility token designed for seamless transactions, staking rewards, and exclusive access to TradeWise premium ecosystem.' }}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="coinPrice">Price Information</label>
                                                <input type="text" class="form-control" id="coinPrice" name="price" 
                                                       value="{{ tradewise_coin.price|default:'$0.10 per TWC (Limited Supply)' }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="coinBonus">Bonus Text</label>
                                                <input type="text" class="form-control" id="coinBonus" name="bonus_text" 
                                                       value="{{ tradewise_coin.bonus_text|default:'Early investors get +15% bonus tokens in the first round.' }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="coinImage">Coin Image</label>
                                                <input type="file" class="form-control" id="coinImage" name="image" accept="image/*">
                                                {% if tradewise_coin.image %}
                                                <div class="mt-2">
                                                    <img src="{{ tradewise_coin.image.url }}" alt="Current image" style="max-width: 200px;">
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="form-group">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="coinActive" name="is_active" 
                                                           {% if tradewise_coin.is_active %}checked{% endif %}>
                                                    <label class="custom-control-label" for="coinActive">Active</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-gradient-primary">
                                            <i class="fas fa-save"></i> Update Coin Details
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- ALL REQUESTS TAB -->
                    <div id="all-requests" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">All Service Requests</h3>
                                <span class="badge badge-warning">{{ pending_requests_count }} Pending</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Type</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Service Type</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="requestsTableBody">
                                            {% for request in all_requests %}
                                            <tr>
                                                <td>
                                                    {% if request.service_type %}
                                                        REQ{{ request.id|stringformat:"03d" }}
                                                    {% elif request.class_interest %}
                                                        CON{{ request.id|stringformat:"03d" }}
                                                    {% elif request.class_type %}
                                                        CLS{{ request.id|stringformat:"03d" }}
                                                    {% else %}
                                                        REV{{ request.id|stringformat:"03d" }}
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if request.service_type %}
                                                        Service
                                                    {% elif request.class_interest %}
                                                        Consultation
                                                    {% elif request.class_type %}
                                                        Class
                                                    {% else %}
                                                        Revenue
                                                    {% endif %}
                                                </td>
                                                <td>{{ request.name }}</td>
                                                <td>{{ request.email }}</td>
                                                <td>{{ request.phone }}</td>
                                                <td>
                                                    {% if request.service_type %}
                                                        {{ request.service_type }}
                                                    {% elif request.class_interest %}
                                                        {{ request.class_interest }}
                                                    {% elif request.class_type %}
                                                        {{ request.get_class_type_display }}
                                                    {% else %}
                                                        {{ request.service_type }}
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge badge-{{ request.status|lower }} status-badge">{{ request.status }}</span>
                                                </td>
                                                <td>{{ request.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" onclick="viewRequest({{ request.id }}, '{% if request.service_type %}GeneralServiceRequest{% elif request.class_interest %}ConsultationRequest{% elif request.class_type %}CoachingRequest{% else %}ServiceRevenue{% endif %}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% if request.status != 'Completed' and request.status != 'completed' and request.status != 'confirmed' %}
                                                    <button class="btn btn-sm btn-success" onclick="updateRequestStatus({{ request.id }}, '{% if request.service_type %}Completed{% elif request.class_interest %}completed{% elif request.class_type %}completed{% else %}confirmed{% endif %}', '{% if request.service_type %}GeneralServiceRequest{% elif request.class_interest %}ConsultationRequest{% elif request.class_type %}CoachingRequest{% else %}ServiceRevenue{% endif %}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="9" class="text-center text-muted">No service requests found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- USERS MANAGEMENT TAB -->
                    <div id="users" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Users Management</h3>
                                <span class="badge badge-info">{{ total_users }} Total Users</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Account No.</th>
                                                <th>Status</th>
                                                <th>Last Login</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for user in users %}
                                            <tr>
                                                <td>USR{{ user.id|stringformat:"03d" }}</td>
                                                <td>{{ user.first_name }} {{ user.second_name }}</td>
                                                <td>{{ user.email }}</td>
                                                <td>{{ user.phone|default:"Not provided" }}</td>
                                                <td>{{ user.account_number }}</td>
                                                <td>
                                                    {% if user.is_active %}
                                                    <span class="badge badge-success">Active</span>
                                                    {% else %}
                                                    <span class="badge badge-danger">Disabled</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ user.last_login|date:"M d, Y H:i"|default:"Never" }}</td>
                                                <td>{{ user.created_at|date:"M d, Y" }}</td>
                                                <td>
                                                    <div class="btn-group">
                                                        {% if user.is_active %}
                                                        <button class="btn btn-sm btn-warning" onclick="disableUser({{ user.id }})" title="Disable Account">
                                                            <i class="fas fa-user-slash"></i>
                                                        </button>
                                                        {% else %}
                                                        <button class="btn btn-sm btn-success" onclick="enableUser({{ user.id }})" title="Enable Account">
                                                            <i class="fas fa-user-check"></i>
                                                        </button>
                                                        {% endif %}
                                                        <button class="btn btn-sm btn-info" onclick="resetUserPassword({{ user.id }})" title="Send Password Reset">
                                                            <i class="fas fa-key"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-secondary" onclick="viewUserDetails({{ user.id }})" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="9" class="text-center text-muted">No users found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- REVIEWS MANAGEMENT TAB -->
                    <div id="reviews" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Reviews Management</h3>
                                <div class="card-tools">
                                    <button class="btn btn-gradient-primary" data-toggle="modal" data-target="#addReviewModal">
                                        <i class="fas fa-plus"></i> Add New Review
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                
                                <!-- Reviews Statistics -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-primary">
                                            <span class="info-box-icon"><i class="fas fa-star"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Total Reviews</span>
                                                <span class="info-box-number">{{ total_reviews|default:"0" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-success">
                                            <span class="info-box-icon"><i class="fas fa-check-circle"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Approved</span>
                                                <span class="info-box-number">{{ approved_reviews|default:"0" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-warning">
                                            <span class="info-box-icon"><i class="fas fa-clock"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Pending</span>
                                                <span class="info-box-number">{{ pending_reviews|default:"0" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-info">
                                            <span class="info-box-icon"><i class="fas fa-feather"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Featured</span>
                                                <span class="info-box-number">{{ featured_reviews|default:"0" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Quick Actions</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="btn-group">
                                                    <button class="btn btn-success btn-sm" onclick="approveAllPending()">
                                                        <i class="fas fa-check-double"></i> Approve All Pending
                                                    </button>
                                                    <button class="btn btn-warning btn-sm" onclick="featureTopRated()">
                                                        <i class="fas fa-star"></i> Feature 5-Star Reviews
                                                    </button>
                                                    <button class="btn btn-info btn-sm" onclick="exportReviews()">
                                                        <i class="fas fa-download"></i> Export Reviews
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Reviews Table -->
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Avatar</th>
                                                <th>Reviewer</th>
                                                <th>Role</th>
                                                <th>Rating</th>
                                                <th>Review</th>
                                                <th>Email</th>
                                                <th>Status</th>
                                                <th>Featured</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for review in reviews %}
                                            <tr>
                                                <td>
                                                    <span class="badge badge-primary">RV{{ review.id|stringformat:"04d" }}</span>
                                                </td>
                                                <td>
                                                    {% if review.image %}
                                                    <img src="{{ review.image.url }}" alt="{{ review.author_name }}" 
                                                         class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                                                    {% else %}
                                                    <div class="no-avatar bg-secondary rounded-circle d-flex align-items-center justify-content-center" 
                                                         style="width: 40px; height: 40px;">
                                                        <i class="fas fa-user text-white"></i>
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong>{{ review.author_name }}</strong>
                                                    {% if review.from_admin %}
                                                    <br><small class="text-muted"><i class="fas fa-crown text-warning"></i> Admin Upload</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge badge-info">{{ review.user_role }}</span>
                                                </td>
                                                <td>
                                                    <div class="star-rating-display">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= review.rating %}
                                                                <span class="star filled">â˜…</span>
                                                            {% else %}
                                                                <span class="star">â˜…</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                        <br>
                                                        <small class="text-muted">{{ review.rating }}/5</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="review-text" data-toggle="tooltip" title="{{ review.content }}">
                                                        {{ review.content|truncatewords:10 }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if review.email %}
                                                    <small>{{ review.email }}</small>
                                                    {% else %}
                                                    <span class="text-muted">No email</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if review.is_approved %}
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check-circle"></i> Approved
                                                    </span>
                                                    {% else %}
                                                    <span class="badge badge-warning">
                                                        <i class="fas fa-clock"></i> Pending
                                                    </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if review.is_featured %}
                                                    <span class="badge badge-warning">
                                                        <i class="fas fa-star"></i> Featured
                                                    </span>
                                                    {% else %}
                                                    <span class="badge badge-secondary">
                                                        <i class="fas fa-star"></i> Regular
                                                    </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {{ review.created_at|date:"M d, Y" }}<br>
                                                        <span class="text-muted">{{ review.created_at|date:"H:i" }}</span>
                                                    </small>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        {% if not review.is_approved %}
                                                        <button type="button" class="btn btn-success" 
                                                                onclick="approveReview({{ review.id }})"
                                                                data-toggle="tooltip" title="Approve Review">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        {% endif %}
                                                        
                                                        {% if review.is_featured %}
                                                        <button type="button" class="btn btn-warning" 
                                                                onclick="toggleFeatured({{ review.id }}, false)"
                                                                data-toggle="tooltip" title="Remove from Featured">
                                                            <i class="fas fa-star-half-alt"></i>
                                                        </button>
                                                        {% else %}
                                                        <button type="button" class="btn btn-outline-warning" 
                                                                onclick="toggleFeatured({{ review.id }}, true)"
                                                                data-toggle="tooltip" title="Feature Review">
                                                            <i class="fas fa-star"></i>
                                                        </button>
                                                        {% endif %}
                                                        
                                                        <button type="button" class="btn btn-info" 
                                                                onclick="viewReviewDetails({{ review.id }})"
                                                                data-toggle="tooltip" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        
                                                        <button type="button" class="btn btn-danger" 
                                                                onclick="deleteReview({{ review.id }}, '{{ review.author_name }}')"
                                                                data-toggle="tooltip" title="Delete Review">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="11" class="text-center py-5">
                                                    <div class="empty-state">
                                                        <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                                                        <h5 class="text-muted">No Reviews Found</h5>
                                                        <p class="text-muted">Get started by adding your first review.</p>
                                                        <button class="btn btn-gradient-primary" data-toggle="modal" data-target="#addReviewModal">
                                                            <i class="fas fa-plus"></i> Add First Review
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                {% if reviews.has_other_pages %}
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <nav aria-label="Reviews pagination">
                                            <ul class="pagination justify-content-center">
                                                {% if reviews.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?reviews_page={{ reviews.previous_page_number }}#reviews">Previous</a>
                                                </li>
                                                {% else %}
                                                <li class="page-item disabled">
                                                    <span class="page-link">Previous</span>
                                                </li>
                                                {% endif %}

                                                {% for i in reviews.paginator.page_range %}
                                                {% if reviews.number == i %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ i }}</span>
                                                </li>
                                                {% else %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?reviews_page={{ i }}#reviews">{{ i }}</a>
                                                </li>
                                                {% endif %}
                                                {% endfor %}

                                                {% if reviews.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?reviews_page={{ reviews.next_page_number }}#reviews">Next</a>
                                                </li>
                                                {% else %}
                                                <li class="page-item disabled">
                                                    <span class="page-link">Next</span>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>




                    
                    <!-- AFFILIATE MANAGEMENT TAB -->
                    <div id="affiliate-management" class="content-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Affiliate Program Management</h3>
                                <div class="card-tools">
                                    <span class="badge badge-primary mr-2">Total Affiliates: {{ total_affiliates }}</span>
                                    <span class="badge badge-warning">Pending Payouts: {{ pending_payouts_count }}</span>
                                    <span class="badge badge-info ml-2">Debug: {{ affiliate_debug.pending_referrals }} Pending / {{ affiliate_debug.approved_referrals }} Approved</span>
                                </div>
                            </div>
                            <div class="card-body">
                                
                                <!-- Weekly Number Management -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-gradient-primary text-white">
                                                <h4 class="card-title mb-0">
                                                    <i class="fas fa-star"></i> Weekly TradeWise Number
                                                </h4>
                                            </div>
                                            <div class="card-body">
                                                <form method="POST" action="{% url 'admin_dashboard' %}" class="row align-items-end" data-ajax="true">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="update_weekly_number">
                                                    
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <label for="weeklyNumber" class="font-weight-bold">This Week's Number</label>
                                                            <input type="text" class="form-control" id="weeklyNumber" name="weekly_number" 
                                                                   value="{{ current_weekly_number.number|default:'7 8 4 2 1' }}" 
                                                                   placeholder="e.g., 7 8 4 2 1" required>
                                                            <small class="form-text text-muted">Enter 5 digits separated by spaces</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <label for="weekStart" class="font-weight-bold">Week Starting</label>
                                                            <input type="date" class="form-control" id="weekStart" name="week_start" 
                                                                   value="{{ current_weekly_number.week_start|date:'Y-m-d'|default:'' }}" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <button type="submit" class="btn btn-success btn-block">
                                                                <i class="fas fa-save"></i> Update Weekly Number
                                                            </button>
                                                        </div>
                                                    </div>
                                                </form>
                                                
                                                {% if previous_numbers %}
                                                <div class="mt-3">
                                                    <h6>Previous Numbers:</h6>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        {% for number in previous_numbers %}
                                                        <span class="badge badge-secondary">{{ number.number }} ({{ number.week_start|date:"M d" }})</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Affiliate Statistics -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-primary">
                                            <span class="info-box-icon"><i class="fas fa-users"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Total Affiliates</span>
                                                <span class="info-box-number">{{ total_affiliates }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-success">
                                            <span class="info-box-icon"><i class="fas fa-coins"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Total Coins Earned</span>
                                                <span class="info-box-number">{{ total_coins_earned }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-warning">
                                            <span class="info-box-icon"><i class="fas fa-money-bill-wave"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Pending Payouts</span>
                                                <span class="info-box-number">{{ pending_payouts_count }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-box bg-gradient-info">
                                            <span class="info-box-icon"><i class="fas fa-hand-holding-usd"></i></span>
                                            <div class="info-box-content">
                                                <span class="info-box-text">Total Paid Out</span>
                                                <span class="info-box-number">KES {{ total_paid_out|floatformat:2 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Debug Information -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card card-outline card-info">
                                            <div class="card-header">
                                                <h3 class="card-title">
                                                    <i class="fas fa-bug"></i> System Debug Info
                                                </h3>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <strong>Pending Referrals:</strong> {{ affiliate_debug.pending_referrals }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Approved Referrals:</strong> {{ affiliate_debug.approved_referrals }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Total Coins Awarded:</strong> {{ affiliate_debug.total_coins_awarded }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Total Coin Balance:</strong> {{ affiliate_debug.total_coin_balance }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pending Payouts -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">Pending Payout Requests</h3>
                                                <span class="badge badge-warning">{{ pending_payouts_count }} Pending</span>
                                            </div>
                                            <div class="card-body">
                                                {% if pending_payouts %}
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Request ID</th>
                                                                <th>User</th>
                                                                <th>Coins</th>
                                                                <th>Amount (KES)</th>
                                                                <th>Payment Method</th>
                                                                <th>Account Details</th>
                                                                <th>Requested</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for payout in pending_payouts %}
                                                            <tr>
                                                                <td>PO{{ payout.id|stringformat:"04d" }}</td>
                                                                <td>
                                                                    <strong>{{ payout.user.first_name }} {{ payout.user.second_name }}</strong><br>
                                                                    <small class="text-muted">{{ payout.user.email }}</small>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-primary">{{ payout.coin_amount }}</span>
                                                                </td>
                                                                <td>
                                                                    <strong>KES {{ payout.amount_kes|floatformat:2 }}</strong>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-info">{{ payout.get_payment_method_display }}</span>
                                                                </td>
                                                                <td>
                                                                    <small>
                                                                        {% if payout.payment_method == 'mpesa' %}
                                                                        M-Pesa: {{ payout.mpesa_number }}
                                                                        {% elif payout.payment_method == 'bank' %}
                                                                        Bank: {{ payout.bank_account }}<br>
                                                                        Name: {{ payout.bank_name }}
                                                                        {% elif payout.payment_method == 'paypal' %}
                                                                        PayPal: {{ payout.paypal_email }}
                                                                        {% endif %}
                                                                    </small>
                                                                </td>
                                                                <td>{{ payout.created_at|date:"M d, Y H:i" }}</td>
                                                                <td>
                                                                    <div class="btn-group">
                                                                        <button class="btn btn-sm btn-success" 
                                                                                onclick="processPayout({{ payout.id }}, 'approved')"
                                                                                title="Approve Payout">
                                                                            <i class="fas fa-check"></i>
                                                                        </button>
                                                                        <button class="btn btn-sm btn-danger" 
                                                                                onclick="processPayout({{ payout.id }}, 'rejected')"
                                                                                title="Reject Payout">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>
                                                                        <button class="btn btn-sm btn-info" 
                                                                                onclick="viewPayoutDetails({{ payout.id }})"
                                                                                title="View Details">
                                                                            <i class="fas fa-eye"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                {% else %}
                                                <div class="text-center py-4">
                                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                                    <h5>No Pending Payouts</h5>
                                                    <p class="text-muted">All payout requests have been processed.</p>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- All Affiliates -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">All Affiliates</h3>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>User ID</th>
                                                                <th>Name</th>
                                                                <th>Email</th>
                                                                <th>Referral Code</th>
                                                                <th>Total Referrals</th>
                                                                <th>Coins Earned</th>
                                                                <th>Coins Balance</th>
                                                                <th>Total Payouts</th>
                                                                <th>Status</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for affiliate in all_affiliates %}
                                                            <tr>
                                                                <td>USR{{ affiliate.user.id|stringformat:"03d" }}</td>
                                                                <td>
                                                                    <strong>{{ affiliate.user.first_name }} {{ affiliate.user.second_name }}</strong>
                                                                </td>
                                                                <td>{{ affiliate.user.email }}</td>
                                                                <td>
                                                                    <code>{{ affiliate.referral_code }}</code>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-primary">{{ affiliate.total_referrals }}</span>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-success">{{ affiliate.total_coins_earned }}</span>
                                                                </td>
                                                                <td>
                                                                    <strong>{{ affiliate.coin_balance }}</strong>
                                                                </td>
                                                                <td>
                                                                    <small>KES {{ affiliate.total_payouts|floatformat:2 }}</small>
                                                                </td>
                                                                <td>
                                                                    {% if affiliate.user.is_active %}
                                                                    <span class="badge badge-success">Active</span>
                                                                    {% else %}
                                                                    <span class="badge badge-danger">Inactive</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-info" onclick="viewAffiliateDetails({{ affiliate.user.id }})">
                                                                        <i class="fas fa-eye"></i> Details
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="10" class="text-center text-muted py-4">
                                                                    <i class="fas fa-users fa-3x mb-3"></i>
                                                                    <p>No affiliates found</p>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </section>
        </div>

        <footer class="main-footer">
            <strong>Copyright &copy; 2025 <a href="{% url 'index' %}">TradeWise</a>.</strong>
            All rights reserved.
            <div class="float-right d-none d-sm-inline-block">
                <b>Version</b> 2.5.0 | <span id="currentDateTime"></span> | 
                <span class="text-success">
                    <i class="fas fa-circle"></i> <span id="connectionStatus">Live</span>
                </span>
            </div>
        </footer>
    </div>

    <!-- MODALS SECTION -->
    {% include 'admin_modals.html' %}

    <!-- jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

    <script>
        // ================== CSRF TOKEN HANDLING ==================
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Set up AJAX CSRF token
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });

        // ================== GLOBAL VARIABLES ==================
        let revenueChart = null;
        let serviceDistributionChart = null;
        let liveUpdateIntervals = {};
        let isActivitiesExpanded = false;

        // ================== INITIALIZATION ==================
        $(document).ready(function() {
            console.log('ðŸš€ Initializing TradeWise Admin Dashboard...');
            
            // Initialize core functionality
            initializeTabSystem();
            initializeCharts();
            initializeLiveUpdates();
            setupAjaxForms();
            updateDateTime();
            loadInitialActivity();
            
            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();
            
            // Adjust footer positioning
            adjustFooter();
            
            console.log('âœ… Dashboard initialized successfully');
        });

        // ================== TAB SYSTEM ==================
        function initializeTabSystem() {
            // Tab switching functionality
            $('.nav-link[data-tab]').on('click', function(e) {
                e.preventDefault();
                const targetTab = $(this).data('tab');
                switchToTab(targetTab);
            });

            // Dashboard card links
            $('.small-box-footer[data-tab]').on('click', function(e) {
                e.preventDefault();
                const targetTab = $(this).data('tab');
                switchToTab(targetTab);
            });
        }

        function switchToTab(tabName) {
            // Hide all tabs
            $('.content-tab').removeClass('active');
            $('.nav-link').removeClass('active');
            
            // Show target tab
            $(`#${tabName}`).addClass('active');
            $(`[data-tab="${tabName}"]`).addClass('active');
            
            // Load tab-specific data if needed
            loadTabData(tabName);
            
            // Log the tab switch
            logAdminAction(`Switched to ${tabName.replace('-', ' ')} tab`);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'users':
                    loadUsersData();
                    break;
                case 'all-requests':
                    loadRequestsData();
                    break;
                case 'reviews':
                    loadReviewsData();
                    break;
                case 'affiliate-management':
                    loadAffiliateData();
                    break;
                case 'software':
                    initializeSoftwareManagement();
                    break;
            }
        }

        // ================== LIVE UPDATES SYSTEM ==================
        function initializeLiveUpdates() {
            console.log('ðŸ”„ Initializing live updates...');
            
            // Start live updates with different intervals
            liveUpdateIntervals.revenue = setInterval(updateRevenueData, 30000); // 30 seconds
            liveUpdateIntervals.activity = setInterval(updateActivityData, 60000); // 60 seconds
            liveUpdateIntervals.stats = setInterval(updateQuickStats, 120000); // 2 minutes
            liveUpdateIntervals.connection = setInterval(checkConnection, 30000); // 30 seconds
            
            // Initial data load
            updateRevenueData();
            updateQuickStats();
            
            console.log('âœ… Live updates initialized');
        }

        function checkConnection() {
            // Simple connection check
            $('#connectionStatus').html('Live <i class="fas fa-signal"></i>');
        }

        // ================== REVENUE CHART UPDATES ==================
        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Daily Revenue (KES)',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `KES ${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'KES ' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'nearest'
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
            }

            // Service Distribution Chart (static for now)
            const serviceCtx = document.getElementById('serviceDistributionChart');
            if (serviceCtx) {
                serviceDistributionChart = new Chart(serviceCtx, {
                    type: 'doughnut',
                    data: {{ service_distribution_data|safe }},
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        },
                        cutout: '60%',
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            }
        }

        function updateRevenueData() {
            $.ajax({
                url: '/admin/ajax/revenue-data/',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && revenueChart) {
                        // Update chart data
                        revenueChart.data.labels = response.dates;
                        revenueChart.data.datasets[0].data = response.amounts;
                        revenueChart.update('none'); // Quiet update
                        
                        // Update revenue stat card
                        $('#totalRevenueStat').text('KES ' + Math.round(response.total_revenue).toLocaleString());
                        
                        // Update last updated time
                        $('#chartLastUpdated').text('Last updated: ' + new Date().toLocaleTimeString());
                        
                        console.log('âœ… Revenue data updated');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('âŒ Revenue data update failed:', error);
                    $('#chartLastUpdated').text('Update failed - Retrying...');
                }
            });
        }

        // ================== QUICK STATS UPDATES ==================
        function updateQuickStats() {
            $.ajax({
                url: '/admin/ajax/quick-stats/',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        // Update all stat cards
                        $('#totalUsersStat').text(response.total_users);
                        $('#newUsersToday').text('+' + response.new_users_today + ' today');
                        
                        $('#pendingRequestsStat').text(response.pending_requests);
                        $('#newRequestsToday').text(response.new_users_today + ' new today');
                        
                        $('#activeTradersStat').text(response.active_traders);
                        $('#newTradersToday').text('+' + response.new_users_today + ' today');
                        
                        // Update badges
                        $('#totalUsersBadge').text(response.total_users);
                        $('#pendingRequestsBadge').text(response.pending_requests);
                        $('#notificationBadge').text(response.pending_requests);
                        $('#notificationHeader').text(response.pending_requests + ' Notifications');
                        $('#newUsersCount').text(response.new_users_today);
                        $('#pendingRequestsCount').text(response.pending_requests);
                        
                        console.log('âœ… Quick stats updated');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('âŒ Quick stats update failed:', error);
                }
            });
        }

        // ================== ACTIVITY SYSTEM ==================
        function loadInitialActivity() {
            updateActivityData();
        }

        function updateActivityData() {
            $.ajax({
                url: '/admin/ajax/activity-data/',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        renderActivities(response.activities);
                        console.log('âœ… Activity data updated');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('âŒ Activity data update failed:', error);
                    $('#activityTimeline').html(`
                        <div class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                            <p class="mt-2">Failed to load activities</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="refreshActivity()">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `);
                }
            });
        }

        function renderActivities(activities) {
            const timeline = $('#activityTimeline');
            
            if (activities.length === 0) {
                timeline.html(`
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p class="mt-2">No recent activity</p>
                    </div>
                `);
                $('#viewMoreContainer').hide();
                return;
            }

            let html = '';
            const visibleCount = isActivitiesExpanded ? activities.length : 4;
            
            activities.slice(0, visibleCount).forEach((activity, index) => {
                html += `
                    <div class="activity-item ${index >= 4 && !isActivitiesExpanded ? 'hidden-activities' : ''}">
                        <div class="d-flex justify-content-between">
                            <strong>${activity.action}</strong>
                            <small class="text-muted">${activity.time_ago}</small>
                        </div>
                        <p class="mb-1">${activity.description}</p>
                        <small class="text-primary">
                            <i class="fas fa-user"></i> ${activity.admin} 
                            <span class="text-muted ml-2">
                                <i class="fas fa-database"></i> ${activity.model}
                            </span>
                        </small>
                    </div>
                `;
            });

            timeline.html(html);
            
            // Show view more if there are more than 4 activities
            if (activities.length > 4) {
                $('#viewMoreContainer').show();
                if (isActivitiesExpanded) {
                    $('#viewMoreBtn').hide();
                    $('#viewLessBtn').show();
                } else {
                    $('#viewMoreBtn').show();
                    $('#viewLessBtn').hide();
                }
            } else {
                $('#viewMoreContainer').hide();
            }
        }

        function toggleActivities() {
            isActivitiesExpanded = !isActivitiesExpanded;
            updateActivityData(); // Re-render with new visibility
        }

        function refreshActivity() {
            $('#activityTimeline').html(`
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2 text-muted">Refreshing activities...</p>
                </div>
            `);
            updateActivityData();
        }

        // ================== AJAX FORM HANDLING ==================
        function setupAjaxForms() {
            // Only intercept forms that should use AJAX
            $(document).on('submit', 'form[data-ajax="true"]', function(e) {
                e.preventDefault();
                submitFormViaAjax($(this));
            });

            // Handle file upload forms with AJAX by default
            $(document).on('submit', 'form[enctype="multipart/form-data"]', function(e) {
                const form = $(this);
                if (form.data('ajax') !== false) {
                    e.preventDefault();
                    submitFormViaAjax(form);
                }
            });
        }

        function submitFormViaAjax(form) {
            const formData = new FormData(form[0]);
            const submitBtn = form.find('button[type="submit"]');
            const originalText = submitBtn.html();
            
            // Show loading state
            showLoading(true);
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
            
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    if (response.success) {
                        showAjaxAlert('success', response.message || 'Operation completed successfully!');
                        
                        // Reset form
                        form[0].reset();
                        
                        // Reset file input labels
                        form.find('.custom-file-label').html('<i class="fas fa-cloud-upload-alt"></i> Choose file...');
                        form.find('.image-preview').hide();
                        
                        // Close modal if exists
                        const modal = form.closest('.modal');
                        if (modal.length) {
                            modal.modal('hide');
                        }
                        
                        // Refresh relevant data
                        refreshDataAfterAction(form);
                        
                    } else {
                        showAjaxAlert('error', response.error || 'An error occurred.');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'Error submitting form. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    } else if (xhr.status === 413) {
                        errorMessage = 'File too large. Please choose a smaller file.';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Session expired. Please refresh the page and try again.';
                    }
                    showAjaxAlert('error', errorMessage);
                },
                complete: function() {
                    showLoading(false);
                    submitBtn.prop('disabled', false).html(originalText);
                }
            });
        }

        function refreshDataAfterAction(form) {
            const action = form.find('input[name="action"]').val();
            
            switch(action) {
                case 'add_software':
                case 'update_software':
                case 'delete_software':
                    loadSoftwareData();
                    break;
                case 'add_strategy':
                case 'update_strategy':
                case 'delete_strategy':
                    loadStrategiesData();
                    break;
                case 'add_signal':
                case 'update_signal':
                case 'delete_signal':
                    loadSignalsData();
                    break;
                case 'add_service':
                case 'update_service':
                case 'delete_service':
                    loadServicesData();
                    break;
                case 'add_review':
                case 'approve_review':
                case 'toggle_featured':
                case 'delete_review':
                    loadReviewsData();
                    break;
                case 'disable_user':
                case 'enable_user':
                    loadUsersData();
                    break;
                case 'update_weekly_number':
                case 'process_payout':
                    loadAffiliateData();
                    break;
            }
            
            // Always update activity and stats
            updateActivityData();
            updateQuickStats();
        }

        // ================== TAB-SPECIFIC DATA LOADING ==================
        function loadUsersData() {
            $.ajax({
                url: '/admin/ajax/users-data/',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        console.log('Users data loaded:', response.users.length, 'users');
                    }
                }
            });
        }

        function loadRequestsData() {
            $.ajax({
                url: '/admin/ajax/requests-data/',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        console.log('Requests data loaded:', response.requests.length, 'requests');
                    }
                }
            });
        }

        function loadReviewsData() {
            // Refresh reviews data
            console.log('Loading reviews data...');
        }

        function loadAffiliateData() {
            // Refresh affiliate data
            console.log('Loading affiliate data...');
        }

        function loadSoftwareData() {
            // Refresh software data
            console.log('Loading software data...');
        }

        function loadStrategiesData() {
            // Refresh strategies data
            console.log('Loading strategies data...');
        }

        function loadSignalsData() {
            // Refresh signals data
            console.log('Loading signals data...');
        }

        function loadServicesData() {
            // Refresh services data
            console.log('Loading services data...');
        }

        // ================== SOFTWARE MANAGEMENT ==================
        function initializeSoftwareManagement() {
            // File input change handlers
            $('#software_file').on('change', function(e) {
                const file = e.target.files[0];
                const label = $('#software_file_label');
                const validation = validateFileUpload(this);
                
                if (file) {
                    if (validation.valid) {
                        label.html('<i class="fas fa-file"></i> ' + file.name);
                        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                        
                        if (file.size > 10 * 1024 * 1024) {
                            $('#file_size_warning').show().html(
                                `<i class="fas fa-exclamation-triangle"></i> Large file: ${fileSize}MB - Upload may take longer`
                            );
                        } else {
                            $('#file_size_warning').hide();
                        }
                    } else {
                        showAjaxAlert('error', validation.error);
                        $(this).val(''); // Clear the invalid file
                        label.html('<i class="fas fa-cloud-upload-alt"></i> Choose software file...');
                        $('#file_size_warning').hide();
                    }
                } else {
                    label.html('<i class="fas fa-cloud-upload-alt"></i> Choose software file...');
                    $('#file_size_warning').hide();
                }
            });

            $('#software_thumbnail').on('change', function(e) {
                const file = e.target.files[0];
                const label = $('#software_thumbnail_label');
                const preview = $('#thumbnail_preview');
                const previewImage = $('#preview_image');
                
                if (file) {
                    label.html('<i class="fas fa-image"></i> ' + file.name);
                    
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.attr('src', e.target.result);
                            preview.show();
                        }
                        reader.readAsDataURL(file);
                    }
                } else {
                    label.html('<i class="fas fa-image"></i> Choose thumbnail...');
                    preview.hide();
                }
            });

            // Form validation
            $('#softwareUploadForm').on('submit', function(e) {
                const fileInput = $('#software_file')[0];
                if (!fileInput.files.length) {
                    e.preventDefault();
                    showAjaxAlert('error', 'Please select a software file to upload.');
                    fileInput.focus();
                    return false;
                }
            });
        }

        function validateFileUpload(fileInput, maxSizeMB = 50) {
            const file = fileInput.files[0];
            if (!file) return { valid: false, error: 'Please select a file' };
            
            const maxSize = maxSizeMB * 1024 * 1024; // Convert to bytes
            const allowedTypes = [
                'application/zip', 
                'application/x-rar-compressed',
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/octet-stream' // For .exe, .mt4, .mt5 files
            ];
            
            if (file.size > maxSize) {
                return { 
                    valid: false, 
                    error: `File size must be less than ${maxSizeMB}MB` 
                };
            }
            
            // Check file extension for additional security
            const fileName = file.name.toLowerCase();
            const allowedExtensions = ['.exe', '.zip', '.rar', '.pdf', '.doc', '.docx', '.mt4', '.mt5', '.mq4', '.mq5'];
            const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension && !allowedTypes.includes(file.type)) {
                return { 
                    valid: false, 
                    error: 'Invalid file type. Please upload a supported file format.' 
                };
            }
            
            return { valid: true };
        }

        function showSoftwareDetails(softwareId) {
            $.ajax({
                url: `/admin/ajax/software-details/${softwareId}/`,
                type: 'GET',
                success: function(response) {
                    $('#softwareDetailsContent').html(response.html);
                    $('#softwareDetailsModal').modal('show');
                },
                error: function() {
                    showAjaxAlert('error', 'Failed to load software details.');
                }
            });
        }

        function editSoftware(softwareId) {
            showAjaxAlert('info', 'Edit functionality coming soon!');
        }

        function deleteSoftware(softwareId, softwareName) {
            if (confirm(`Are you sure you want to delete "${softwareName}"? This action cannot be undone.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '';
                
                const csrfToken = getCookie('csrftoken');
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'delete_software';
                form.appendChild(actionInput);
                
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'item_id';
                idInput.value = softwareId;
                form.appendChild(idInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function trackDownload(softwareId) {
            // Track download count via AJAX
            $.ajax({
                url: `/admin/track-download/${softwareId}/`,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: getCookie('csrftoken')
                },
                success: function(response) {
                    if (response.success) {
                        console.log('Download tracked for software ID:', softwareId);
                    }
                }
            });
        }

        function showImageModal(imageUrl, title) {
            $('#modalPreviewImage').attr('src', imageUrl);
            $('#imagePreviewTitle').text(title);
            $('#imagePreviewModal').modal('show');
        }

        // ================== REVIEWS MANAGEMENT ==================
        function initializeReviewsManagement() {
            // Avatar preview
            $('#review_avatar').on('change', function(e) {
                const file = e.target.files[0];
                const label = $('#avatar_label');
                const preview = $('#avatar_preview');
                const previewImage = $('#preview_avatar');
                
                if (file) {
                    label.html('<i class="fas fa-image"></i> ' + file.name);
                    
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.attr('src', e.target.result);
                            preview.show();
                        }
                        reader.readAsDataURL(file);
                    }
                } else {
                    label.html('<i class="fas fa-image"></i> Choose avatar...');
                    preview.hide();
                }
            });
            
            // Star rating selection
            $('.star-rating-input-large input').on('change', function() {
                const rating = $(this).val();
                console.log('Selected rating:', rating);
            });

            // Form validation
            $('#addReviewForm').on('submit', function(e) {
                const rating = $('input[name="rating"]:checked').val();
                if (!rating) {
                    e.preventDefault();
                    showAjaxAlert('error', 'Please select a rating for the review.');
                    return false;
                }
            });
        }

        function approveReview(reviewId) {
            if (confirm('Are you sure you want to approve this review?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'admin_dashboard' %}";
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = getCookie('csrftoken');
                form.appendChild(csrf);
                
                const action = document.createElement('input');
                action.type = 'hidden';
                action.name = 'action';
                action.value = 'approve_review';
                form.appendChild(action);
                
                const reviewIdInput = document.createElement('input');
                reviewIdInput.type = 'hidden';
                reviewIdInput.name = 'review_id';
                reviewIdInput.value = reviewId;
                form.appendChild(reviewIdInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function toggleFeatured(reviewId, feature) {
            const action = feature ? 'feature' : 'unfeature';
            const message = feature ? 'Are you sure you want to feature this review?' : 'Are you sure you want to remove this review from featured?';
            
            if (confirm(message)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'admin_dashboard' %}";
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = getCookie('csrftoken');
                form.appendChild(csrf);
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'toggle_featured';
                form.appendChild(actionInput);
                
                const reviewIdInput = document.createElement('input');
                reviewIdInput.type = 'hidden';
                reviewIdInput.name = 'review_id';
                reviewIdInput.value = reviewId;
                form.appendChild(reviewIdInput);
                
                const featureInput = document.createElement('input');
                featureInput.type = 'hidden';
                featureInput.name = 'feature';
                featureInput.value = feature;
                form.appendChild(featureInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function deleteReview(reviewId, reviewerName) {
            if (confirm(`Are you sure you want to delete the review from "${reviewerName}"? This action cannot be undone.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'admin_dashboard' %}";
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = getCookie('csrftoken');
                form.appendChild(csrf);
                
                const action = document.createElement('input');
                action.type = 'hidden';
                action.name = 'action';
                action.value = 'delete_review';
                form.appendChild(action);
                
                const reviewIdInput = document.createElement('input');
                reviewIdInput.type = 'hidden';
                reviewIdInput.name = 'review_id';
                reviewIdInput.value = reviewId;
                form.appendChild(reviewIdInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function viewReviewDetails(reviewId) {
            // Fetch review details via AJAX
            $.ajax({
                url: `/admin/ajax/review-details/${reviewId}/`,
                type: 'GET',
                success: function(response) {
                    $('#reviewDetailsContent').html(response.html);
                    $('#reviewDetailsModal').modal('show');
                },
                error: function() {
                    showAjaxAlert('error', 'Failed to load review details.');
                }
            });
        }

        // ================== AFFILIATE MANAGEMENT ==================
        function processPayout(payoutId, status) {
            const actionText = status === 'approved' ? 'approve' : 'reject';
            if (confirm(`Are you sure you want to ${actionText} this payout request?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'admin_dashboard' %}";
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = getCookie('csrftoken');
                form.appendChild(csrf);
                
                const action = document.createElement('input');
                action.type = 'hidden';
                action.name = 'action';
                action.value = 'process_payout';
                form.appendChild(action);
                
                const payoutIdInput = document.createElement('input');
                payoutIdInput.type = 'hidden';
                payoutIdInput.name = 'payout_id';
                payoutIdInput.value = payoutId;
                form.appendChild(payoutIdInput);
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                statusInput.value = status;
                form.appendChild(statusInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function viewAffiliateDetails(userId) {
            // Fetch affiliate details via AJAX
            fetch(`/admin/ajax/affiliate-details/${userId}/`)
                .then(response => response.json())
                .then(data => {
                    showAffiliateDetailsModal(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAjaxAlert('error', 'Failed to load affiliate details.');
                });
        }

        // ================== UTILITY FUNCTIONS ==================
        function showLoading(show) {
            if (show) {
                $('#globalLoading').fadeIn();
            } else {
                $('#globalLoading').fadeOut();
            }
        }

        function showAjaxAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show ajax-alert" role="alert">
                    <strong><i class="fas ${icon}"></i> ${type === 'success' ? 'Success!' : type === 'error' ? 'Error!' : 'Notice!'}</strong> 
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            
            $('#ajaxMessagesContainer').html(alertHtml);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                $('.ajax-alert').alert('close');
            }, 5000);
        }

        function updateDateTime() {
            const now = new Date();
            $('#currentDateTime').text(now.toLocaleString());
            setTimeout(updateDateTime, 1000);
        }

        function adjustFooter() {
            const contentHeight = $('.content-wrapper').height();
            const windowHeight = $(window).height();
            
            if (contentHeight < windowHeight - 100) {
                $('footer').addClass('fixed-bottom');
            } else {
                $('footer').removeClass('fixed-bottom');
            }
        }

        function logAdminAction(description) {
            // Log admin action for tracking
            console.log('ðŸ“ Admin Action:', description);
        }

        // ================== EXISTING FUNCTIONS (compatibility) ==================
        function readURL(input, previewId) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $(previewId).attr('src', e.target.result);
                    $(previewId).show();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Delete item function
        function deleteItem(type, id) {
            if (confirm(`Are you sure you want to delete this ${type}?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'admin_dashboard' %}";
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = getCookie('csrftoken');
                form.appendChild(csrf);
                
                const action = document.createElement('input');
                action.type = 'hidden';
                action.name = 'action';
                action.value = `delete_${type}`;
                form.appendChild(action);
                
                const itemId = document.createElement('input');
                itemId.type = 'hidden';
                itemId.name = 'item_id';
                itemId.value = id;
                form.appendChild(itemId);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Edit functions (to be implemented)
        function editStrategy(id) {
            showAjaxAlert('info', 'Edit strategy functionality coming soon!');
        }

        function editSignal(id) {
            showAjaxAlert('info', 'Edit signal functionality coming soon!');
        }

        function editClass(id) {
            showAjaxAlert('info', 'Edit class functionality coming soon!');
        }

        function editService(id) {
            showAjaxAlert('info', 'Edit service functionality coming soon!');
        }

        function editBlog(id) {
            showAjaxAlert('info', 'Edit blog functionality coming soon!');
        }

        function editMerchandise(id) {
            showAjaxAlert('info', 'Edit merchandise functionality coming soon!');
        }

        // User management functions
        function disableUser(userId) {
            if (confirm('Are you sure you want to disable this user account?')) {
                // Implement disable user functionality
                showAjaxAlert('info', 'User disable functionality coming soon!');
            }
        }

        function enableUser(userId) {
            if (confirm('Are you sure you want to enable this user account?')) {
                // Implement enable user functionality
                showAjaxAlert('info', 'User enable functionality coming soon!');
            }
        }

        function resetUserPassword(userId) {
            if (confirm('Send password reset email to this user?')) {
                // Implement password reset functionality
                showAjaxAlert('info', 'Password reset functionality coming soon!');
            }
        }

        function viewUserDetails(userId) {
            // Implement view user details functionality
            showAjaxAlert('info', 'User details functionality coming soon!');
        }

        // Window resize handler
        $(window).on('resize', adjustFooter);

        // Cleanup on page unload
        $(window).on('beforeunload', function() {
            // Clear all intervals
            Object.values(liveUpdateIntervals).forEach(interval => {
                clearInterval(interval);
            });
        });
    </script>


<script>
    // ================== TRADEWISE ADMIN DASHBOARD - COMPREHENSIVE JS ==================

// ================== GLOBAL VARIABLES ==================
let revenueChart = null;
let serviceDistributionChart = null;
let liveUpdateIntervals = {};
let isActivitiesExpanded = false;
let isStaffUser = false;
let isFullAdmin = false;

// ================== CSRF TOKEN HANDLING ==================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Set up AJAX CSRF token
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    }
});

// ================== ROLE-BASED ACCESS CONTROL ==================
function initializeRoleBasedAccess() {
    console.log('ðŸ” INITIALIZING ROLE-BASED ACCESS CONTROL...');
    
    // Get user role from multiple sources
    const userRole = "{{ user_role }}";
    isStaffUser = "{{ is_staff_user }}" === "True";
    isFullAdmin = "{{ is_full_admin }}" === "True";
    const djangoIsStaff = "{{ request.user.is_staff }}" === "True";
    const djangoIsSuperuser = "{{ request.user.is_superuser }}" === "True";
    
    console.log('ðŸ‘¤ USER ROLE DETECTION:');
    console.log('  - Template user_role:', userRole);
    console.log('  - Template is_staff_user:', isStaffUser);
    console.log('  - Template is_full_admin:', isFullAdmin);
    console.log('  - Django is_staff:', djangoIsStaff);
    console.log('  - Django is_superuser:', djangoIsSuperuser);
    
    // Final determination - if staff but not superuser, apply restrictions
    const shouldRestrict = (isStaffUser && !isFullAdmin) || (djangoIsStaff && !djangoIsSuperuser);
    
    if (shouldRestrict) {
        console.log('ðŸ”’ APPLYING STAFF RESTRICTIONS...');
        isStaffUser = true;
        isFullAdmin = false;
        applyStaffRestrictions();
        showStaffRestrictionNotice();
    } else {
        console.log('ðŸ‘‘ FULL ADMIN ACCESS - No restrictions applied');
        isStaffUser = false;
        isFullAdmin = true;
    }
}

function applyStaffRestrictions() {
    console.log('ðŸ›¡ï¸ Applying comprehensive staff restrictions...');
    
    // Define accessible sections (only these will be enabled for staff)
    const accessibleSections = ['dashboard', 'users', 'affiliate-management', 'all-requests'];
    const restrictedSections = ['strategies', 'signals', 'classes', 'services', 'software', 
                               'blog', 'tradewise-card', 'merchandise', 'tradewise-coin', 'reviews'];
    
    // 1. RESTRICT NAVIGATION ITEMS
    $('.nav-link[data-tab]').each(function() {
        const tabName = $(this).data('tab');
        const $navItem = $(this).closest('.nav-item');
        
        if (!accessibleSections.includes(tabName)) {
            console.log(`ðŸš« Restricting navigation: ${tabName}`);
            
            // Add restricted class
            $navItem.addClass('staff-restricted');
            $(this).addClass('disabled text-muted');
            
            // Remove all existing click events
            $(this).off('click');
            
            // Add restricted click handler
            $(this).on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                showAjaxAlert('error', 'âŒ Access Denied: This section is restricted to administrators only.');
                return false;
            });
            
            // Add restriction badge
            if (!$(this).find('.admin-only-badge').length) {
                $(this).find('p').append(
                    '<span class="badge badge-danger admin-only-badge ml-2"><i class="fas fa-lock"></i> Admin Only</span>'
                );
            }
            
            // Add tooltip
            $(this).attr('title', 'ðŸ”’ Administrator access required');
            $(this).tooltip('dispose').tooltip();
        }
    });
    
    // 2. RESTRICT DASHBOARD CARD LINKS
    $('.small-box-footer[data-tab]').each(function() {
        const tab = $(this).data('tab');
        if (tab && !accessibleSections.includes(tab)) {
            $(this).addClass('disabled text-muted staff-restricted-link');
            $(this).attr('href', 'javascript:void(0)');
            $(this).attr('title', 'Restricted to administrators');
            $(this).tooltip('dispose').tooltip();
            $(this).off('click').on('click', function(e) {
                e.preventDefault();
                showAjaxAlert('error', 'âŒ Access Denied: This section is restricted to administrators only.');
            });
        }
    });
    
    // 3. RESTRICT MODAL BUTTONS
    $('[data-target*="Modal"]').each(function() {
        const modalId = $(this).data('target');
        if (modalId) {
            const restrictedModals = ['#addStrategyModal', '#addSignalModal', '#addClassModal', 
                                    '#addServiceModal', '#addSoftwareModal', '#addBlogModal',
                                    '#addMerchandiseModal', '#addReviewModal'];
            
            if (restrictedModals.includes(modalId)) {
                $(this).addClass('disabled staff-restricted-btn');
                $(this).attr('title', 'Administrator access required');
                $(this).tooltip('dispose').tooltip();
                $(this).off('click').on('click', function(e) {
                    e.preventDefault();
                    showAjaxAlert('error', 'âŒ Access Denied: This action requires administrator privileges.');
                });
            }
        }
    });
    
    // 4. ADD STAFF INDICATOR
    $('.brand-text').append(' <small class="text-warning staff-mode-indicator"><i class="fas fa-user-shield"></i> Staff Mode</small>');
    
    console.log('âœ… Staff restrictions applied successfully');
}

function showStaffRestrictionNotice() {
    // Remove any existing notice
    $('#staffNotification').remove();
    
    // Add comprehensive staff notice
    const noticeHtml = `
        <div class="alert alert-warning alert-dismissible" id="staffNotification">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <h5><i class="fas fa-user-shield"></i> Staff Access Mode Active</h5>
            <p class="mb-1"><strong>Your access is limited to the following sections only:</strong></p>
            <ul class="mb-1">
                <li>Dashboard Overview</li>
                <li>User Management</li>
                <li>Affiliate Program</li>
                <li>Service Requests</li>
            </ul>
            <small class="text-muted">Contact an administrator for full system access.</small>
        </div>
    `;
    
    // Insert at the top of content
    $('.content').prepend(noticeHtml);
}

// ================== TAB SYSTEM WITH ACCESS CONTROL ==================
function initializeTabSystem() {
    console.log('ðŸ“ Initializing tab system with access control...');
    
    // Tab switching functionality with access control
    $('.nav-link[data-tab]').on('click', function(e) {
        if ($(this).hasClass('disabled')) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
        
        const targetTab = $(this).data('tab');
        if (!switchToTab(targetTab)) {
            e.preventDefault();
            e.stopPropagation();
        }
    });

    // Dashboard card links with access control
    $('.small-box-footer[data-tab]').on('click', function(e) {
        if ($(this).hasClass('disabled')) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
        
        const targetTab = $(this).data('tab');
        if (!switchToTab(targetTab)) {
            e.preventDefault();
            e.stopPropagation();
        }
    });
}

function switchToTab(tabName) {
    // Server-side access control check
    const restrictedSections = ['strategies', 'signals', 'classes', 'services', 'software', 
                               'blog', 'tradewise-card', 'merchandise', 'tradewise-coin', 'reviews'];
    
    if (isStaffUser && restrictedSections.includes(tabName)) {
        showAjaxAlert('error', `âŒ Access Denied: The "${formatTabName(tabName)}" section is restricted to administrators only.`);
        return false;
    }
    
    // Hide all tabs
    $('.content-tab').removeClass('active');
    $('.nav-link').removeClass('active');
    
    // Show target tab
    $(`#${tabName}`).addClass('active');
    $(`[data-tab="${tabName}"]`).addClass('active');
    
    // Load tab-specific data if needed
    loadTabData(tabName);
    
    // Log the tab switch
    logAdminAction(`Switched to ${formatTabName(tabName)}`);
    
    return true;
}

function formatTabName(tabName) {
    return tabName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

function loadTabData(tabName) {
    switch(tabName) {
        case 'users':
            loadUsersData();
            break;
        case 'all-requests':
            loadRequestsData();
            break;
        case 'reviews':
            if (!isStaffUser) loadReviewsData();
            break;
        case 'affiliate-management':
            loadAffiliateData();
            break;
        case 'software':
            if (!isStaffUser) initializeSoftwareManagement();
            break;
    }
}

// ================== DASHBOARD INITIALIZATION ==================
$(document).ready(function() {
    console.log('ðŸš€ Initializing TradeWise Admin Dashboard...');
    
    // Initialize in correct order
    initializeRoleBasedAccess();  // FIRST - set up access control
    initializeTabSystem();        // SECOND - set up tab system with access control
    initializeCharts();           // THIRD - initialize charts
    initializeLiveUpdates();      // FOURTH - set up live updates
    setupAjaxForms();             // FIFTH - set up form handling
    updateDateTime();             // SIXTH - start clock
    loadInitialActivity();        // SEVENTH - load initial data
    
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Adjust footer positioning
    adjustFooter();
    
    console.log('âœ… Dashboard initialized successfully with role-based access control');
});

// ================== LIVE UPDATES SYSTEM ==================
function initializeLiveUpdates() {
    console.log('ðŸ”„ Initializing live updates...');
    
    // Start live updates with different intervals
    liveUpdateIntervals.revenue = setInterval(updateRevenueData, 30000);
    liveUpdateIntervals.activity = setInterval(updateActivityData, 60000);
    liveUpdateIntervals.stats = setInterval(updateQuickStats, 120000);
    liveUpdateIntervals.connection = setInterval(checkConnection, 30000);
    
    // Initial data load
    updateRevenueData();
    updateQuickStats();
    
    console.log('âœ… Live updates initialized');
}

function checkConnection() {
    $('#connectionStatus').html('Live <i class="fas fa-signal"></i>');
}

// ================== CHART SYSTEM ==================
function initializeCharts() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Daily Revenue (KES)',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `KES ${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        },
                        grid: { color: 'rgba(0,0,0,0.1)' }
                    },
                    x: {
                        grid: { color: 'rgba(0,0,0,0.1)' }
                    }
                },
                interaction: { intersect: false, mode: 'nearest' },
                animation: { duration: 1000, easing: 'easeInOutQuart' }
            }
        });
    }

    // Service Distribution Chart
    const serviceCtx = document.getElementById('serviceDistributionChart');
    if (serviceCtx) {
        serviceDistributionChart = new Chart(serviceCtx, {
            type: 'doughnut',
            data: {{ service_distribution_data|safe }},
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 20, usePointStyle: true }
                    }
                },
                cutout: '60%',
                animation: { animateScale: true, animateRotate: true }
            }
        });
    }
}

function updateRevenueData() {
    if (isStaffUser) return; // Staff don't need revenue updates
    
    $.ajax({
        url: '/admin/ajax/revenue-data/',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success && revenueChart) {
                revenueChart.data.labels = response.dates;
                revenueChart.data.datasets[0].data = response.amounts;
                revenueChart.update('none');
                $('#totalRevenueStat').text('KES ' + Math.round(response.total_revenue).toLocaleString());
                $('#chartLastUpdated').text('Last updated: ' + new Date().toLocaleTimeString());
            }
        },
        error: function(xhr, status, error) {
            $('#chartLastUpdated').text('Update failed - Retrying...');
        }
    });
}

// ================== QUICK STATS UPDATES ==================
function updateQuickStats() {
    $.ajax({
        url: '/admin/ajax/quick-stats/',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                $('#totalUsersStat').text(response.total_users);
                $('#newUsersToday').text('+' + response.new_users_today + ' today');
                $('#pendingRequestsStat').text(response.pending_requests);
                $('#activeTradersStat').text(response.active_traders);
                
                // Update badges
                $('#totalUsersBadge').text(response.total_users);
                $('#pendingRequestsBadge').text(response.pending_requests);
                $('#notificationBadge').text(response.pending_requests);
                $('#notificationHeader').text(response.pending_requests + ' Notifications');
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ Quick stats update failed:', error);
        }
    });
}

// ================== ACTIVITY SYSTEM ==================
function loadInitialActivity() {
    updateActivityData();
}

function updateActivityData() {
    $.ajax({
        url: '/admin/ajax/activity-data/',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                renderActivities(response.activities);
            }
        },
        error: function(xhr, status, error) {
            $('#activityTimeline').html(`
                <div class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                    <p class="mt-2">Failed to load activities</p>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="refreshActivity()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `);
        }
    });
}

function renderActivities(activities) {
    const timeline = $('#activityTimeline');
    
    if (activities.length === 0) {
        timeline.html(`
            <div class="text-center py-4 text-muted">
                <i class="fas fa-inbox fa-2x"></i>
                <p class="mt-2">No recent activity</p>
            </div>
        `);
        $('#viewMoreContainer').hide();
        return;
    }

    let html = '';
    const visibleCount = isActivitiesExpanded ? activities.length : 4;
    
    activities.slice(0, visibleCount).forEach((activity, index) => {
        html += `
            <div class="activity-item ${index >= 4 && !isActivitiesExpanded ? 'hidden-activities' : ''}">
                <div class="d-flex justify-content-between">
                    <strong>${activity.action}</strong>
                    <small class="text-muted">${activity.time_ago}</small>
                </div>
                <p class="mb-1">${activity.description}</p>
                <small class="text-primary">
                    <i class="fas fa-user"></i> ${activity.admin} 
                    <span class="text-muted ml-2">
                        <i class="fas fa-database"></i> ${activity.model}
                    </span>
                </small>
            </div>
        `;
    });

    timeline.html(html);
    
    if (activities.length > 4) {
        $('#viewMoreContainer').show();
        if (isActivitiesExpanded) {
            $('#viewMoreBtn').hide();
            $('#viewLessBtn').show();
        } else {
            $('#viewMoreBtn').show();
            $('#viewLessBtn').hide();
        }
    } else {
        $('#viewMoreContainer').hide();
    }
}

function toggleActivities() {
    isActivitiesExpanded = !isActivitiesExpanded;
    updateActivityData();
}

function refreshActivity() {
    $('#activityTimeline').html(`
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2 text-muted">Refreshing activities...</p>
        </div>
    `);
    updateActivityData();
}

// ================== AJAX FORM HANDLING ==================
function setupAjaxForms() {
    $(document).on('submit', 'form[data-ajax="true"]', function(e) {
        e.preventDefault();
        submitFormViaAjax($(this));
    });

    $(document).on('submit', 'form[enctype="multipart/form-data"]', function(e) {
        const form = $(this);
        if (form.data('ajax') !== false) {
            e.preventDefault();
            submitFormViaAjax(form);
        }
    });
}

function submitFormViaAjax(form) {
    // Check if staff user is trying to perform restricted actions
    if (isStaffUser) {
        const action = form.find('input[name="action"]').val();
        const restrictedActions = ['add_strategy', 'add_signal', 'add_class', 'add_service', 
                                 'add_software', 'add_blog', 'add_merchandise', 'update_card',
                                 'update_coin', 'delete_strategy', 'delete_signal', 'delete_class',
                                 'delete_service', 'delete_software', 'delete_blog', 'delete_merchandise'];
        
        if (restrictedActions.includes(action)) {
            showAjaxAlert('error', 'âŒ Access Denied: This action requires administrator privileges.');
            return;
        }
    }
    
    const formData = new FormData(form[0]);
    const submitBtn = form.find('button[type="submit"]');
    const originalText = submitBtn.html();
    
    showLoading(true);
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
    
    $.ajax({
        url: form.attr('action'),
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                showAjaxAlert('success', response.message || 'Operation completed successfully!');
                form[0].reset();
                
                const modal = form.closest('.modal');
                if (modal.length) {
                    modal.modal('hide');
                }
                
                refreshDataAfterAction(form);
            } else {
                showAjaxAlert('error', response.error || 'An error occurred.');
            }
        },
        error: function(xhr, status, error) {
            let errorMessage = 'Error submitting form. Please try again.';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            showAjaxAlert('error', errorMessage);
        },
        complete: function() {
            showLoading(false);
            submitBtn.prop('disabled', false).html(originalText);
        }
    });
}

function refreshDataAfterAction(form) {
    const action = form.find('input[name="action"]').val();
    
    switch(action) {
        case 'add_software':
        case 'update_software':
        case 'delete_software':
            loadSoftwareData();
            break;
        case 'add_strategy':
        case 'update_strategy':
        case 'delete_strategy':
            loadStrategiesData();
            break;
        case 'add_signal':
        case 'update_signal':
        case 'delete_signal':
            loadSignalsData();
            break;
        case 'add_service':
        case 'update_service':
        case 'delete_service':
            loadServicesData();
            break;
        case 'add_review':
        case 'approve_review':
        case 'toggle_featured':
        case 'delete_review':
            loadReviewsData();
            break;
        case 'disable_user':
        case 'enable_user':
            loadUsersData();
            break;
        case 'update_weekly_number':
        case 'process_payout':
            loadAffiliateData();
            break;
    }
    
    updateActivityData();
    updateQuickStats();
}

// ================== TAB-SPECIFIC DATA LOADING ==================
function loadUsersData() {
    $.ajax({
        url: '/admin/ajax/users-data/',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                console.log('Users data loaded:', response.users.length, 'users');
            }
        }
    });
}

function loadRequestsData() {
    $.ajax({
        url: '/admin/ajax/requests-data/',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                console.log('Requests data loaded:', response.requests.length, 'requests');
            }
        }
    });
}

function loadReviewsData() {
    console.log('Loading reviews data...');
}

function loadAffiliateData() {
    console.log('Loading affiliate data...');
}

function loadSoftwareData() {
    if (isStaffUser) return;
    console.log('Loading software data...');
}

function loadStrategiesData() {
    if (isStaffUser) return;
    console.log('Loading strategies data...');
}

function loadSignalsData() {
    if (isStaffUser) return;
    console.log('Loading signals data...');
}

function loadServicesData() {
    if (isStaffUser) return;
    console.log('Loading services data...');
}

// ================== SOFTWARE MANAGEMENT ==================
function initializeSoftwareManagement() {
    if (isStaffUser) return;
    
    $('#software_file').on('change', function(e) {
        const file = e.target.files[0];
        const label = $('#software_file_label');
        const validation = validateFileUpload(this);
        
        if (file) {
            if (validation.valid) {
                label.html('<i class="fas fa-file"></i> ' + file.name);
                const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                
                if (file.size > 10 * 1024 * 1024) {
                    $('#file_size_warning').show().html(
                        `<i class="fas fa-exclamation-triangle"></i> Large file: ${fileSize}MB - Upload may take longer`
                    );
                } else {
                    $('#file_size_warning').hide();
                }
            } else {
                showAjaxAlert('error', validation.error);
                $(this).val('');
                label.html('<i class="fas fa-cloud-upload-alt"></i> Choose software file...');
                $('#file_size_warning').hide();
            }
        } else {
            label.html('<i class="fas fa-cloud-upload-alt"></i> Choose software file...');
            $('#file_size_warning').hide();
        }
    });

    $('#software_thumbnail').on('change', function(e) {
        const file = e.target.files[0];
        const label = $('#software_thumbnail_label');
        const preview = $('#thumbnail_preview');
        const previewImage = $('#preview_image');
        
        if (file) {
            label.html('<i class="fas fa-image"></i> ' + file.name);
            
            if (file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.attr('src', e.target.result);
                    preview.show();
                }
                reader.readAsDataURL(file);
            }
        } else {
            label.html('<i class="fas fa-image"></i> Choose thumbnail...');
            preview.hide();
        }
    });

    $('#softwareUploadForm').on('submit', function(e) {
        const fileInput = $('#software_file')[0];
        if (!fileInput.files.length) {
            e.preventDefault();
            showAjaxAlert('error', 'Please select a software file to upload.');
            fileInput.focus();
            return false;
        }
    });
}

function validateFileUpload(fileInput, maxSizeMB = 50) {
    const file = fileInput.files[0];
    if (!file) return { valid: false, error: 'Please select a file' };
    
    const maxSize = maxSizeMB * 1024 * 1024;
    const allowedTypes = [
        'application/zip', 
        'application/x-rar-compressed',
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/octet-stream'
    ];
    
    if (file.size > maxSize) {
        return { 
            valid: false, 
            error: `File size must be less than ${maxSizeMB}MB` 
        };
    }
    
    const fileName = file.name.toLowerCase();
    const allowedExtensions = ['.exe', '.zip', '.rar', '.pdf', '.doc', '.docx', '.mt4', '.mt5', '.mq4', '.mq5'];
    const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
    
    if (!hasValidExtension && !allowedTypes.includes(file.type)) {
        return { 
            valid: false, 
            error: 'Invalid file type. Please upload a supported file format.' 
        };
    }
    
    return { valid: true };
}

function showSoftwareDetails(softwareId) {
    $.ajax({
        url: `/admin/ajax/software-details/${softwareId}/`,
        type: 'GET',
        success: function(response) {
            $('#softwareDetailsContent').html(response.html);
            $('#softwareDetailsModal').modal('show');
        },
        error: function() {
            showAjaxAlert('error', 'Failed to load software details.');
        }
    });
}

function editSoftware(softwareId) {
    showAjaxAlert('info', 'Edit functionality coming soon!');
}

function deleteSoftware(softwareId, softwareName) {
    if (isStaffUser) {
        showAjaxAlert('error', 'âŒ Access Denied: This action requires administrator privileges.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete "${softwareName}"? This action cannot be undone.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '';
        
        const csrfToken = getCookie('csrftoken');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'delete_software';
        form.appendChild(actionInput);
        
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'item_id';
        idInput.value = softwareId;
        form.appendChild(idInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function trackDownload(softwareId) {
    $.ajax({
        url: `/admin/track-download/${softwareId}/`,
        type: 'POST',
        data: { csrfmiddlewaretoken: getCookie('csrftoken') },
        success: function(response) {
            if (response.success) {
                console.log('Download tracked for software ID:', softwareId);
            }
        }
    });
}

function showImageModal(imageUrl, title) {
    $('#modalPreviewImage').attr('src', imageUrl);
    $('#imagePreviewTitle').text(title);
    $('#imagePreviewModal').modal('show');
}

// ================== UTILITY FUNCTIONS ==================
function showLoading(show) {
    if (show) {
        $('#globalLoading').fadeIn();
    } else {
        $('#globalLoading').fadeOut();
    }
}

function showAjaxAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const icon = type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show ajax-alert" role="alert">
            <strong><i class="fas ${icon}"></i> ${type === 'success' ? 'Success!' : type === 'error' ? 'Error!' : 'Notice!'}</strong> 
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `;
    
    $('#ajaxMessagesContainer').html(alertHtml);
    
    setTimeout(() => {
        $('.ajax-alert').alert('close');
    }, 5000);
}

function updateDateTime() {
    const now = new Date();
    $('#currentDateTime').text(now.toLocaleString());
    setTimeout(updateDateTime, 1000);
}

function adjustFooter() {
    const contentHeight = $('.content-wrapper').height();
    const windowHeight = $(window).height();
    
    if (contentHeight < windowHeight - 100) {
        $('footer').addClass('fixed-bottom');
    } else {
        $('footer').removeClass('fixed-bottom');
    }
}

function logAdminAction(description) {
    console.log('ðŸ“ Admin Action:', description);
}

// ================== COMPATIBILITY FUNCTIONS ==================
function readURL(input, previewId) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            $(previewId).attr('src', e.target.result);
            $(previewId).show();
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function deleteItem(type, id) {
    if (isStaffUser) {
        showAjaxAlert('error', 'âŒ Access Denied: This action requires administrator privileges.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete this ${type}?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'admin_dashboard' %}";
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = getCookie('csrftoken');
        form.appendChild(csrf);
        
        const action = document.createElement('input');
        action.type = 'hidden';
        action.name = 'action';
        action.value = `delete_${type}`;
        form.appendChild(action);
        
        const itemId = document.createElement('input');
        itemId.type = 'hidden';
        itemId.name = 'item_id';
        itemId.value = id;
        form.appendChild(itemId);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Edit functions
function editStrategy(id) { showAjaxAlert('info', 'Edit strategy functionality coming soon!'); }
function editSignal(id) { showAjaxAlert('info', 'Edit signal functionality coming soon!'); }
function editClass(id) { showAjaxAlert('info', 'Edit class functionality coming soon!'); }
function editService(id) { showAjaxAlert('info', 'Edit service functionality coming soon!'); }
function editBlog(id) { showAjaxAlert('info', 'Edit blog functionality coming soon!'); }
function editMerchandise(id) { showAjaxAlert('info', 'Edit merchandise functionality coming soon!'); }

// User management functions
function disableUser(userId) {
    if (confirm('Are you sure you want to disable this user account?')) {
        showAjaxAlert('info', 'User disable functionality coming soon!');
    }
}

function enableUser(userId) {
    if (confirm('Are you sure you want to enable this user account?')) {
        showAjaxAlert('info', 'User enable functionality coming soon!');
    }
}

function resetUserPassword(userId) {
    if (confirm('Send password reset email to this user?')) {
        showAjaxAlert('info', 'Password reset functionality coming soon!');
    }
}

function viewUserDetails(userId) {
    showAjaxAlert('info', 'User details functionality coming soon!');
}

// Window resize handler
$(window).on('resize', adjustFooter);

// Cleanup on page unload
$(window).on('beforeunload', function() {
    Object.values(liveUpdateIntervals).forEach(interval => {
        clearInterval(interval);
    });
});

// ================== EMERGENCY STAFF DETECTION ==================
setTimeout(function() {
    console.log('ðŸ”„ Running final staff access check...');
    
    // Final verification - if staff restrictions should be applied but aren't visible
    const shouldBeStaff = "{{ is_staff_user }}" === "True" || ("{{ request.user.is_staff }}" === "True" && "{{ request.user.is_superuser }}" !== "True");
    
    if (shouldBeStaff && !$('.staff-mode-indicator').length) {
        console.log('ðŸ†˜ EMERGENCY: Applying staff restrictions via fallback');
        isStaffUser = true;
        applyStaffRestrictions();
        showStaffRestrictionNotice();
    }
}, 2000);
</script>

<style>
    /* Staff restriction styles */
.nav-item.disabled {
    opacity: 0.6;
    pointer-events: none;
}

.nav-link.disabled {
    color: #6c757d !important;
    cursor: not-allowed;
}

.staff-restricted {
    border-left: 3px solid #dc3545;
}

.admin-only-badge {
    font-size: 0.6rem;
    padding: 2px 5px;
    margin-left: 5px;
}
</style>


<script>
    // ================== REVENUE CHART UPDATES ==================
function updateRevenueData() {
    $.ajax({
        url: '/admin/ajax/revenue-data/',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            console.log('ðŸ“Š Revenue data response:', response);
            
            if (response.success && revenueChart) {
                // Update chart data
                revenueChart.data.labels = response.daily_data.dates;
                revenueChart.data.datasets[0].data = response.daily_data.amounts;
                revenueChart.update();
                
                // Update revenue stat card
                $('#totalRevenueStat').text('KES ' + Math.round(response.summary.total_revenue).toLocaleString());
                
                // Update last updated time
                $('#chartLastUpdated').text('Last updated: ' + new Date().toLocaleTimeString());
                
                console.log('âœ… Revenue data updated successfully');
            } else {
                console.error('âŒ Revenue data response not successful:', response);
                $('#chartLastUpdated').text('Data load failed');
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ Revenue data update failed:', error);
            $('#chartLastUpdated').text('Update failed - Retrying...');
        }
    });
}

// ================== QUICK STATS UPDATES ==================
function updateQuickStats() {
    $.ajax({
        url: '/admin/ajax/quick-stats/',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            console.log('ðŸ“ˆ Quick stats response:', response);
            
            if (response.success) {
                // Update all stat cards with new response structure
                $('#totalUsersStat').text(response.total_users);
                $('#newUsersToday').text('+' + response.new_users_today + ' today');
                
                $('#pendingRequestsStat').text(response.pending_requests);
                $('#newRequestsToday').text(response.new_users_today + ' new today');
                
                $('#activeTradersStat').text(response.active_users);
                $('#newTradersToday').text('+' + response.new_users_today + ' today');
                
                // Update revenue with actual data
                $('#totalRevenueStat').text('KES ' + Math.round(response.total_revenue).toLocaleString());
                
                // Update badges
                $('#totalUsersBadge').text(response.total_users);
                $('#pendingRequestsBadge').text(response.pending_requests);
                $('#notificationBadge').text(response.pending_requests);
                $('#notificationHeader').text(response.pending_requests + ' Notifications');
                
                console.log('âœ… Quick stats updated successfully');
            } else {
                console.error('âŒ Quick stats response not successful:', response);
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ Quick stats update failed:', error);
        }
    });
}


// ================== USER MANAGEMENT FUNCTIONS ==================

// View User Details Function
function viewUserDetails(userId) {
    console.log('ðŸ‘¤ Loading user details for ID:', userId);
    
    showLoading(true);
    
    $.ajax({
        url: `/admin/ajax/user-details/${userId}/`,
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            showLoading(false);
            
            if (response.success) {
                // Populate the user details modal
                populateUserDetailsModal(response.user);
                $('#userDetailsModal').modal('show');
            } else {
                showAjaxAlert('error', response.error || 'Failed to load user details.');
            }
        },
        error: function(xhr, status, error) {
            showLoading(false);
            showAjaxAlert('error', 'Failed to load user details. Please try again.');
            console.error('User details error:', error);
        }
    });
}

// Populate User Details Modal
function populateUserDetailsModal(userData) {
    // Basic Information
    $('#userDetailsName').text(`${userData.first_name} ${userData.second_name}`);
    $('#userDetailsEmail').text(userData.email);
    $('#userDetailsPhone').text(userData.phone || 'Not provided');
    $('#userDetailsAccountNo').text(userData.account_number);
    $('#userDetailsStatus').html(userData.is_active ? 
        '<span class="badge badge-success">Active</span>' : 
        '<span class="badge badge-danger">Disabled</span>'
    );
    
    // Account Information
    $('#userDetailsCreated').text(new Date(userData.created_at).toLocaleDateString());
    $('#userDetailsLastLogin').text(userData.last_login ? 
        new Date(userData.last_login).toLocaleString() : 'Never'
    );
    
    // Additional Details
    $('#userDetailsId').text(`USR${String(userData.id).padStart(3, '0')}`);
    $('#userDetailsRole').text(userData.is_staff ? 'Staff User' : 'Regular User');
    
    // Service Requests Count
    $('#userDetailsRequests').text(userData.service_requests_count || 0);
    
    // Affiliate Information
    if (userData.affiliate_info) {
        $('#userDetailsAffiliate').html(`
            <span class="badge badge-info">Affiliate</span>
            <small class="text-muted ml-2">Code: ${userData.affiliate_info.referral_code}</small>
        `);
    } else {
        $('#userDetailsAffiliate').html('<span class="badge badge-secondary">Not an affiliate</span>');
    }
    
    // Update action buttons
    updateUserActionButtons(userData);
}

// Update action buttons based on user status
function updateUserActionButtons(userData) {
    const actionsHtml = `
        <div class="btn-group-vertical w-100">
            ${userData.is_active ? 
                `<button class="btn btn-warning btn-sm mb-2" onclick="disableUser(${userData.id})">
                    <i class="fas fa-user-slash"></i> Disable Account
                </button>` :
                `<button class="btn btn-success btn-sm mb-2" onclick="enableUser(${userData.id})">
                    <i class="fas fa-user-check"></i> Enable Account
                </button>`
            }
            <button class="btn btn-info btn-sm mb-2" onclick="resetUserPassword(${userData.id})">
                <i class="fas fa-key"></i> Reset Password
            </button>
            <button class="btn btn-secondary btn-sm" onclick="sendWelcomeEmail(${userData.id})">
                <i class="fas fa-envelope"></i> Send Welcome Email
            </button>
        </div>
    `;
    
    $('#userDetailsActions').html(actionsHtml);
}

// Disable User Account
function disableUser(userId) {
    if (confirm('Are you sure you want to disable this user account? The user will not be able to log in until the account is re-enabled.')) {
        performUserAction(userId, 'disable_user', 'disable');
    }
}

// Enable User Account
function enableUser(userId) {
    if (confirm('Are you sure you want to enable this user account? The user will be able to log in again.')) {
        performUserAction(userId, 'enable_user', 'enable');
    }
}

// Reset User Password
function resetUserPassword(userId) {
    if (confirm('Send password reset email to this user? They will receive instructions to set a new password.')) {
        performUserAction(userId, 'reset_password', 'password reset');
    }
}

// Send Welcome Email
function sendWelcomeEmail(userId) {
    if (confirm('Send welcome email to this user?')) {
        performUserAction(userId, 'send_welcome_email', 'welcome email');
    }
}

// Perform User Action (Generic)
function performUserAction(userId, action, actionName) {
    showLoading(true);
    
    $.ajax({
        url: '/admin/ajax/user-action/',
        type: 'POST',
        data: {
            user_id: userId,
            action: action,
            csrfmiddlewaretoken: getCookie('csrftoken')
        },
        dataType: 'json',
        success: function(response) {
            showLoading(false);
            
            if (response.success) {
                showAjaxAlert('success', response.message || `User ${actionName} completed successfully!`);
                
                // Close modal if open
                $('#userDetailsModal').modal('hide');
                
                // Refresh users data
                loadUsersData();
                
                // Update activity log
                updateActivityData();
                
            } else {
                showAjaxAlert('error', response.error || `Failed to ${actionName} user.`);
            }
        },
        error: function(xhr, status, error) {
            showLoading(false);
            showAjaxAlert('error', `Error performing ${actionName}. Please try again.`);
            console.error('User action error:', error);
        }
    });
}

// Enhanced Users Data Loading
function loadUsersData() {
    $.ajax({
        url: '/admin/ajax/users-data/',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                updateUsersTable(response.users);
                console.log('âœ… Users data loaded:', response.users.length, 'users');
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ Users data load failed:', error);
        }
    });
}

// Update Users Table
function updateUsersTable(users) {
    const tbody = $('#usersTableBody');
    let html = '';
    
    users.forEach(user => {
        html += `
            <tr>
                <td>USR${String(user.id).padStart(3, '0')}</td>
                <td>${user.first_name} ${user.second_name}</td>
                <td>${user.email}</td>
                <td>${user.phone || 'Not provided'}</td>
                <td>${user.account_number}</td>
                <td>
                    ${user.is_active ? 
                        '<span class="badge badge-success">Active</span>' : 
                        '<span class="badge badge-danger">Disabled</span>'
                    }
                </td>
                <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                <td>
                    <div class="btn-group">
                        ${user.is_active ? 
                            `<button class="btn btn-sm btn-warning" onclick="disableUser(${user.id})" title="Disable Account">
                                <i class="fas fa-user-slash"></i>
                            </button>` :
                            `<button class="btn btn-sm btn-success" onclick="enableUser(${user.id})" title="Enable Account">
                                <i class="fas fa-user-check"></i>
                            </button>`
                        }
                        <button class="btn btn-sm btn-info" onclick="resetUserPassword(${user.id})" title="Send Password Reset">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="viewUserDetails(${user.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.html(html || `
        <tr>
            <td colspan="9" class="text-center text-muted">No users found</td>
        </tr>
    `);
}

// Initialize User Management
function initializeUserManagement() {
    console.log('ðŸ‘¥ Initializing user management...');
    
    // Load initial users data
    loadUsersData();
    
    // Set up user search functionality
    $('#userSearch').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        filterUsersTable(searchTerm);
    });
    
    // Set up user status filter
    $('#userStatusFilter').on('change', function() {
        filterUsersByStatus($(this).val());
    });
}

// Filter Users Table
function filterUsersTable(searchTerm) {
    const rows = $('#usersTableBody tr');
    
    rows.each(function() {
        const row = $(this);
        const text = row.text().toLowerCase();
        row.toggle(text.includes(searchTerm));
    });
}

// Filter Users by Status
function filterUsersByStatus(status) {
    const rows = $('#usersTableBody tr');
    
    rows.each(function() {
        const row = $(this);
        if (status === 'all') {
            row.show();
        } else if (status === 'active') {
            row.toggle(row.find('.badge-success').length > 0);
        } else if (status === 'disabled') {
            row.toggle(row.find('.badge-danger').length > 0);
        }
    });
}

// Add this to your existing initialization
$(document).ready(function() {
    // ... your existing code ...
    
    // Initialize user management when users tab is loaded
    $(document).on('click', '[data-tab="users"]', function() {
        initializeUserManagement();
    });
    
    // Or initialize immediately if users tab is active
    if ($('#users').hasClass('active')) {
        initializeUserManagement();
    }
});
</script>
</body>
</html>